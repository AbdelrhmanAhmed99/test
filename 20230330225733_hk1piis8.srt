1
00:00:00,540 --> 00:00:06,541
Speaker 0: Well, I would not say this is like an unreasonable approach for a first implementation. Sure.

2
00:00:06,822 --> 00:00:10,713
Speaker 1: But this is where, you know, Satoshi's been gone for a little bit.

3
00:00:11,194 --> 00:00:12,638
Speaker 0: Interesting.

4
00:00:18,775 --> 00:00:19,000
Speaker 2: Hey Jonas.

5
00:00:19,441 --> 00:00:23,658
Speaker 1: Hey Murch. We are here with one of your wallet collaborators, H.O.L. 101.

6
00:00:24,505 --> 00:00:25,959
Speaker 2: Well, the wallet guy.

7
00:00:26,404 --> 00:00:28,000
Speaker 1: Yeah, but he's still, you're still a collaborator.

8
00:00:28,641 --> 00:00:37,000
Speaker 2: Sure, sure. So Andy has been working on the Bitcoin Core wallet for many years and he's covered a lot of different topics and we're going to pick his brain on them.

9
00:00:37,801 --> 00:01:00,000
Speaker 1: Descriptor wallets, the big refactor that he did a couple years ago, PSBT's hardware wallet integration, this migration from legacy wallet to descriptor wallets. Lots to cover. Hope you enjoy the episode. So the first question I'm going to ask you is, why do we need a wallet in Bitcoin Core?

10
00:01:00,000 --> 00:01:03,919
Speaker 0: Well, you got to make transactions somehow. If we didn't have transactions, we wouldn't have Bitcoin.

11
00:01:04,844 --> 00:01:07,658
Speaker 1: Yeah, but like other people are doing wallets and...

12
00:01:08,224 --> 00:01:14,000
Speaker 2: They're doing it full time. Yeah, they got nice gooeys. They're building nice features.

13
00:01:15,103 --> 00:01:36,000
Speaker 0: So, so the Bitcoin Core wallet can be used for some more power usury things. OK. And I guess maybe not the wallet itself, but Bitcoin Core provides a lot of utilities for doing some fairly low level things. And some of those are in the wallet. And you can do some weird stuff with your transactions.

14
00:01:36,080 --> 00:01:40,939
Speaker 1: Do we want weird stuff with our transactions to be the value prop of the wallet?

15
00:01:41,400 --> 00:02:09,000
Speaker 0: It's a good point. I mean, it's good for like... I guess a good way to look at it is like it's a kind of a research, research and development product. Right. You use this to do research, use it to do experimentation. And if you want to, if you wanted to build a wallet that targets something like a specific type of script, a specific use case, you could start with experimenting on the Bitcoin Core wallet before you move out to whatever targets, whatever specific thing you're trying to target.

16
00:02:09,380 --> 00:02:31,378
Speaker 2: I think generally Bitcoin Core will be on the forefront of what's possible with wallets, not feature wise, but script wise and protocol wise. So we're working on mini script descriptors. We, with Create Raw Transaction, you can build non-standard transactions, which hardly any wallet can do.

17
00:02:32,804 --> 00:02:35,939
Speaker 1: But again, why is that the value prop?

18
00:02:36,080 --> 00:03:09,000
Speaker 2: I think it's important to have one wallet that shows what's possible for other wallets to make use of that in features. There's a few wallets, for example, Liana Wallet came out recently with an interesting script that I hadn't seen in another wallet yet, which is essentially a decaying multisig where at some point other keys get access to your coins. But if you just keep moving your funds about three times a year, it'll remain under your sole control.

19
00:03:09,141 --> 00:03:10,535
Speaker 1: That's the revolt, folks.

20
00:03:11,142 --> 00:03:11,897
Speaker 0: Yes, exactly.

21
00:03:12,000 --> 00:03:13,030
Speaker 1: So this is like sort of a vaulting.

22
00:03:14,020 --> 00:03:14,626
Speaker 2: Yeah.

23
00:03:16,081 --> 00:03:17,000
Speaker 1: Dead man's switch kind of thing.

24
00:03:17,201 --> 00:03:17,844
Speaker 0: Yeah, exactly.

25
00:03:18,065 --> 00:03:19,914
Speaker 2: Built in bequesting of your Bitcoins.

26
00:03:21,301 --> 00:03:23,914
Speaker 0: The other thing is, well, Bitcoin Core has always had a wallet.

27
00:03:25,681 --> 00:03:29,573
Speaker 2: There are some people that will not trust other Bitcoins software there at your core.

28
00:03:32,000 --> 00:04:13,477
Speaker 0: Okay. Going back to the value proposition thing, there's something to be said for having a wallet that is attached to a full node. And because having your own full node means that it gives you better security, better privacy generally. And so having a wallet that's attached to the full node is what a lot of people want, I think. And part of that, even if you had separate software for this, you've raised the barrier of entry. So if someone wants to have a full node wallet, they might have to, oh, you have to download Bitcoin Core. Then they've got to go find some other wallet, figure out how to connect it to Bitcoin Core, and then they can have their full node wallet. Whereas if you just use Bitcoin Core, then everything's all there for you.

29
00:04:14,000 --> 00:04:26,919
Speaker 2: I mean, there is some wallets that actually do use Bitcoin Core, but I think some of them are on Mac. There are some hardware wallets, but you have to get multiple projects to work together in some fashion.

30
00:04:27,140 --> 00:05:01,839
Speaker 1: Yeah, I guess we're not really, I guess I'm just confused about who we're catering to. And if I can be so bold as to tell the person who's been working on Bitcoin Core wallet for five years and has made immeasurable contributions to the wallet, the value prop for me is that it's going to be, there's a higher bar for review and security than anywhere else. And that it's more balanced in terms of showing things like privacy and sort of the innovation pieces, like first half SegWit, first half Taproot, etc. But the security and soundness principles, you're not going to find anywhere else.

31
00:05:02,282 --> 00:05:13,969
Speaker 0: I'm going to contest you on the ASMR review. Oh, great. Wonderful. I think we should have that. Actually, we've had a few people come in last year and do more on the wallet.

32
00:05:18,340 --> 00:05:26,348
Speaker 2: But for a while, the wallet was definitely a part of the code base that got very little action. But the wallet is hopping right now.

33
00:05:26,389 --> 00:05:26,812
Speaker 1: It's hopping.

34
00:05:28,984 --> 00:05:58,416
Speaker 0: A little bit. I mean, it's been getting more review, more work on it. But the area that we have, there's always some focus that most contributors are looking at at one time. It's not intentional, but I've noticed this over the years that there'll be a focus on P2P, a focus on validation, a focus on networking, a focus on the wallet. And it moves around. So a couple of years ago, we had a pretty big focus on the wallet. And we've kind of moved off that just naturally.

35
00:05:59,080 --> 00:06:00,353
Speaker 1: What was the big focus a couple of years ago?

36
00:06:01,000 --> 00:06:05,698
Speaker 0: Mostly on the refactor and all the whole thing with descriptor wallets.

37
00:06:06,221 --> 00:06:13,000
Speaker 1: Well, we're going to put a pin in that and come back to it because it's important. But what do you think is the hottest area right now?

38
00:06:13,662 --> 00:06:18,297
Speaker 0: I think right now it's with P2P and transaction relay.

39
00:06:19,571 --> 00:06:21,918
Speaker 1: Mempool. Mempool. It's so hot right now.

40
00:06:22,462 --> 00:06:27,777
Speaker 0: Mempool. It starts with memes.

41
00:06:28,120 --> 00:06:38,859
Speaker 1: Let's go back a couple of years now and talk about the refactor and the descriptor wallet. Go back to the glory days and tell us about what those projects were about.

42
00:06:39,100 --> 00:08:18,478
Speaker 0: So a long time ago at this point, Peter Waller came up with the idea of these output script descriptors. And the point was to have one string that could be used to represent several scripts, all of the scripts in a wallet actually. And here we're using a script to also mean address, they are interchangeable. So you could have a string that contained all the keys, it contained how to derive those keys, it contained other markers to say like what kind of script to produce and what kind of script probably to produce, which tells us what address we will make. And the goal was to have this in the wallet. A wallet would use these descriptors to produce the addresses. So this would make it really easy to determine what belongs to the wallet. It also makes it a lot easier to upgrade wallets because then you can just say here's a new descriptor and you put it in the wallet and the new descriptor has its definitions will automatically generate all the things. So after Peter had come up with this idea, there was a fork into mini script kind of. And then we started trying to implement it into Bitcoin Core. So this was a fairly big effort. And it turns out that the way that Bitcoin Core was structured was not very good for doing these descriptors. And so before we could even get to that point, we like refactored half of it. And there was a lot of work from myself, from Russ, from Mesh Collider, and then a ton of people were reviewing all of these things, testing it out and experimenting with it. So eventually we got the refactor through and we got the script wallets afterwards, which was also quite a bit of work.

43
00:08:20,222 --> 00:08:40,899
Speaker 1: And I guess looking back on that, first of all, those are two big efforts from someone who, you know, you had been you had had contributions before, but not let anything like that. Can you tell us what that process was like? It was like leading those giant efforts. I remember when that sort of like gist of this is what the refactor is going to look like came out. I was like, well, that's it looks like a lot of work. And I was right.

44
00:08:41,461 --> 00:09:12,919
Speaker 0: Yeah. That also was like. I think it was also the third attempt to get the script wallets through. So we have these core dev in-person events and a lot of the discussion around how we were going to do it ended up taking place during a couple of those, like multiple of them. So this was spread out over quite a while. I guess like it wasn't even that I wanted to lead the project or like lead this effort. I found it interesting. And then I just wrote it and being the one to write something ends up putting you in charge of it.

45
00:09:14,161 --> 00:09:15,484
Speaker 1: So it sure does.

46
00:09:17,086 --> 00:09:31,919
Speaker 0: So, so like I wrote the PR, I wrote a couple of different branches and eventually one of them became a PR and people started reviewing and giving comments. And then like, that's basically how I ended up in charge of this whole effort is because I went through the effort of writing it.

47
00:09:32,220 --> 00:09:36,053
Speaker 2: I think was that before or after you were nominated for wallet maintainer.

48
00:09:36,073 --> 00:09:37,418
Speaker 0: That was long before that.

49
00:09:38,080 --> 00:09:39,483
Speaker 1: This is like, this was like 2018, 2019, something like that.

50
00:09:39,543 --> 00:09:41,487
Speaker 0: Oh, two years ago. Yeah, two years ago.

51
00:09:47,903 --> 00:10:09,839
Speaker 1: For those who can't see us at home, it's that was. those are air quotes. Okay. So you did the refactor, you got descriptor wallets in. Are you happy with where things are at? I mean, I disagree in terms of you're not getting attention. There's the guy sitting at the table with us. There's Furzy, there's Josie. What else do you want, man?

52
00:10:10,340 --> 00:10:19,559
Speaker 0: Well, okay. When I started doing that refactor, I eventually realized actually the way the wallet as it is currently written is kind of really not that great.

53
00:10:20,200 --> 00:10:23,146
Speaker 1: Okay. So the refactor ended up not being that great.

54
00:10:23,446 --> 00:10:39,559
Speaker 0: No, like, like the, just in doing the refactor, I learned a lot about how I see the wallet itself actually works. And, and in doing that, I, it occurred to me that actually this code is not that good. Okay. And well, part of it is that you can trace a significant portion of it back to Satoshi.

55
00:10:40,220 --> 00:10:41,525
Speaker 1: God doesn't even know how to write code.

56
00:10:42,949 --> 00:11:35,000
Speaker 0: This is not the, not the highest quality of code. And, you know, it makes it hard to implement new changes. And it's also not very performant. So around that time, I also had the idea of, well, why don't we just rewrite this thing? This is not a new idea. Actually, if you look at our IRC meetings, this meme has come up multiple times over many years of why don't we just rewrite the wallet? Actually, at some point, I think it became, why don't we just delete the wallet? Because it was getting that hard to work with. And the change to the descriptor wallets ended up rewriting, I would say probably like a third of the wallet. And so there's still two thirds that I'm looking at wanting to do, but there just doesn't seem like the, um, Appetite? Yeah. The appetite for reviewers to look at these changes and to go through with a lot of the things involved in doing this kind of rewrite.

57
00:11:35,261 --> 00:11:37,919
Speaker 1: And what do you think that other two third rewrite will get us?

58
00:11:38,680 --> 00:12:18,000
Speaker 2: So I looked the first time really at the wallet in 2014 when I got interested in coin selection, and you could probably pretty easily still figure out that all of Bitcoin was a part of a single file at some point, almost. It all came out of main.cpp and people had then pulled out a few things. For example, the coin selection stuff had not really been touched since 2011. Somebody introduced an app sack then. Before that, I think it was just either largest first selection or oldest first selection. No, it was all UTXOs for every transaction. Yes. At some point it used all UTXOs for every transaction.

59
00:12:18,222 --> 00:12:19,939
Speaker 0: I don't remember this. I know.

60
00:12:20,382 --> 00:12:22,456
Speaker 1: Guy has a master's thesis. I wouldn't mess with him.

61
00:12:24,061 --> 00:12:43,714
Speaker 0: The very first version of Bitcoin chose coins by TXID order. It used a standard map, which is a sorted data structure, and it was sorted by TXID. So it would take the first thing out of standard map. It wasn't enough to take the second one, the third one, and so on. And so... Seems very efficient.

62
00:12:44,020 --> 00:12:44,626
Speaker 1: Oh, it was very fast.

63
00:12:44,646 --> 00:12:47,527
Speaker 0: I'm sure it's very fast. Quite performant.

64
00:12:48,030 --> 00:12:49,959
Speaker 1: You're recusing Satoshi and not being performant.

65
00:12:50,020 --> 00:12:53,591
Speaker 0: But it's not very good for the optimization. Like anything else.

66
00:12:54,140 --> 00:13:12,836
Speaker 2: Yeah, anyway, somebody put in a map sack. Map sack is terrible. We still have a map sack. And then I think Alex Morkos fixed something about the looping behavior after my master thesis. And then nobody touched that part of the wallet until 2018.

67
00:13:14,102 --> 00:13:37,838
Speaker 0: Until 2017, something like that. Seventeen. So the way that we did coin selection changes was people would use it. They would find, oh, there's this really weird behavior if you do this one really specific thing. And you'd be like, okay, we will fix that thing. Here's an if statement for some wild condition that you probably shouldn't hit, but it's there and it resolves this problem. And that's how we did coin selection. It was completely ad hoc.

68
00:13:38,060 --> 00:13:41,000
Speaker 1: Sounds like an elegant solution. What could go wrong?

69
00:13:41,722 --> 00:14:11,839
Speaker 0: Yeah, it was just completely ad hoc. And there was no overall, like, what do we want coin selection to do? What are we trying to target with it? What kind of coins do we want? What fee rates? All that stuff. None of that was really in consideration, I think. And it was mostly just like, here's a thing that we inherited from people who wrote something several years ago and now it doesn't work. It's completely black magic. We don't know why it doesn't work. We don't know what the hell it's actually doing. And we're just going to throw some special case in for this one broken behavior.

70
00:14:12,220 --> 00:14:24,000
Speaker 1: Yeah, so one of the things that I think seems to have helped with some of that is you have recently done some simulation work so that you can actually simulate some of this behavior. So tell me more about that project.

71
00:14:24,000 --> 00:14:47,000
Speaker 0: So this started when I was interning at Blockstream in 2017. And one of my projects then was to implement Merger's coin selection algorithm in Bitcoin Core. And of course, because coin selection was at that time just a black box, no one knew how it actually worked, there was a question of, well, can you demonstrate that this is better? for some definition of better that is still undefined?

72
00:14:47,120 --> 00:14:53,275
Speaker 1: So I wrote a whole thesis about that. What's the framework of better then?

73
00:14:54,701 --> 00:15:19,959
Speaker 2: Well, there's different metrics that you could use. Mine was what is the overall fee cost and how healthy is the wallet in the end? As in, if you keep fragmenting your wallet more and more, your long term fees that you have essentially for every UTXO that you have in your wallet, you will have to spend money in the future to spend it. So the more fragmented your wallet is, the more future costs you have already locked in.

74
00:15:20,200 --> 00:15:27,819
Speaker 1: But there are other metrics associated with that. So for example, just like a human, be like, well, my cholesterol is high, but my pulse is good. Am I healthy?

75
00:15:28,161 --> 00:15:28,505
Speaker 0: Who knows?

76
00:15:30,280 --> 00:15:43,000
Speaker 2: So I mean, not that strictly where you can look at a single number and you can say, oh, my health score is like that. But we found ways to compare different approaches and see which one is better.

77
00:15:43,000 --> 00:15:46,618
Speaker 1: And are those being integrated into our criteria?

78
00:15:47,120 --> 00:16:16,919
Speaker 2: Like the waste metric is kind of an aggregate of all of these. The waste metric is one of these. with Josie, I've been talking about on and off about how the waste metric should only be one of multiple things that contribute to the score. And we would like to have some scoring mechanism for privacy as a second contributor to which inputs we select. So I don't think it's been our focus yet, but we've been bouncing around some ideas.

79
00:16:17,440 --> 00:16:30,355
Speaker 0: With coin selection, I think, well, so I ended up using a lot of Merges stuff because he was the only one who actually seemed to know anything about coin selection. There was a master's thesis.

80
00:16:31,704 --> 00:16:32,711
Speaker 1: That's why we hired him.

81
00:16:34,100 --> 00:16:36,053
Speaker 2: I thought it was for my Stack Exchange answers.

82
00:16:37,822 --> 00:17:09,122
Speaker 0: Yes. So in 2017, I implemented the coin Merges algorithm, which we call branch and bound. And then in doing that, you know, learned about how coin selection works and doesn't work and realized how our coin selection algorithm was not that good. And this also led to another refactor that ended up being delayed quite a long time just to like clean up coin selection and get rid of some other dumb behavior that we had in it. Yeah.

83
00:17:10,320 --> 00:17:35,000
Speaker 1: So you've taken on us on this tour of getting to coin selection and talking about, you know, simulated behavior, which gives us actually some criteria to compare against, which seems like a good idea. But these aren't your only projects. You've also been thinking about like you led the effort on PSPTs. There's hardware integration. How do these all fit together?

84
00:17:35,661 --> 00:17:46,313
Speaker 0: At some point I got a hardware wallet and I was like, why can't I use this with Bitcoin Core? Turns out because it's very hard.

85
00:17:48,421 --> 00:18:20,156
Speaker 2: So basically you were saying, Hey, I want to be able to transfer a unsigned transaction between one device and another device. And I need a standardized format for that. And it turns out that introducing a format for talking about unsigned or half signed or partially signed transactions is something that a lot of people actually also need and have implemented before. But having a single standard for it was pretty awesome. Down the road, what it makes much, much easier is multi-party transactions.

86
00:18:21,040 --> 00:20:11,734
Speaker 0: Yeah. So it started with, so I wrote HWI as mostly just a toy for experimentation. So Trezor provided a Python library. So I wrote it in Python. Which I really enjoyed. Yeah, it was a brilliant idea. Ledger also provided a Python library. And then what was the other one I had at the time? Coldcard? I don't know. I haven't had any of those years yet. DigitalBitBox. They had a really simple protocol that I could implement in Python. And there might have also been a Python library. So I did it all in Python, mostly for myself. And I found out that, okay, I can get a thing that Bitcoin Core can watch. But how do I get transactions out of Bitcoin Core into this script and get that to all the devices, including all the other information that they need to sign? And that stuff includes, well, for each of those devices, they have different protocols. So you now need to take it in some common format that can give to my program. That needs to convert it into all these other protocols that I can send out to the device. And then recombine it. And it all has to come back out and go the other way into Bitcoin Core. So it turns out that in doing that, I decided to write PSPT as that common data format to transfer information from Bitcoin Core to HWI. And so these two projects were, PSPT and HWI were intrinsically linked from the start. And of course, it turns out that a way to transfer data about transactions to be signed between two different pieces of software is actually really useful, even if one end is not a hardware wallet. Because all of that hardware wallet signing stuff is abstracted away. So being able to have something that I can pass around between different compatible software was really useful for the ecosystem. And then...

87
00:20:12,000 --> 00:20:16,899
Speaker 1: So what other... besides sort of the implicit, it's useful. What other things are using this kind of thing?

88
00:20:17,060 --> 00:20:47,979
Speaker 0: Well, so the other thing is like multi-party transactions. Right. Because we can... just the way that I had written it, and this was also kind of on my mind when I was doing it, but it allows us to do things like multi-sigs or... Pay-in-trans? Coin-joins. Yeah. Anything that required having multiple people involved was made easier by having PSPT because now it was a common data format that contained all the information you needed to know in order to sign it, except for the private keys, obviously. And so you can just pass around to everyone, they can sign it, and it just makes life a lot easier.

89
00:20:48,621 --> 00:21:08,000
Speaker 2: And then now on the other side of this equation, of course, wallets started saying, hey, wait, there is a shared format for talking about partially signed Bitcoin transactions. And now the hardware wallets and other wallets are implementing that, and we get a global standard in how wallets can communicate with each other.

90
00:21:08,380 --> 00:21:26,719
Speaker 0: And one thing I found was that the idea of having a format containing information that you need in order to sign is not new. There was a BIP, BIP-10? Something like that. It was very old. That did something similar to PSPT, but not quite, and it ended up being withdrawn for some reason.

91
00:21:27,323 --> 00:21:27,787
Speaker 1: Who wrote it?

92
00:21:27,828 --> 00:21:49,738
Speaker 0: You know, other show notes. The armory guy, Alan Reiner. Someone pointed this out to me. I was like, oh, I just didn't realize this existed. I read it, it's not the same, and it was missing a bunch of things, I think. But this is not new. Electrum had their own custom format. Bitcoin Core did a thing where it would shove signatures into the raw transaction.

93
00:21:50,000 --> 00:21:51,616
Speaker 2: I mean, BitGo had its own format, too.

94
00:21:52,101 --> 00:22:05,000
Speaker 0: Yeah, I know BitGo had their own format. Zappo had their own format, just like internal use. And no one ever thought to standardize it until I came along and wrote my own thing. I was like, you know, maybe this would be useful for everyone else.

95
00:22:06,807 --> 00:22:15,819
Speaker 1: It's clear that you've developed this affinity for the wallet. Merch already mentioned it. You became a maintainer within the last, it's been about a year, right? December?

96
00:22:16,224 --> 00:22:16,938
Speaker 0: Yeah, I think so.

97
00:22:17,180 --> 00:22:34,516
Speaker 1: So has that changed things for you? Has it changed things? How you approach the wallet, how you think about its future? I mean, we sort of have this idea around maintainership, it's not like an explicit lead, but it often goes to the person who's most active in that area. So how does that change things for you?

98
00:22:35,962 --> 00:23:19,879
Speaker 0: It doesn't change a whole lot in terms of the things that I want to do. It changes how much time I have to do them. So since I've became a maintainer, I've been doing a lot more review. And not just the wallet stuff, because we know like, I mean, recently, relatively recently, both Peter and Vytomir have stepped down as maintainers. And we do need maintainers to look at all parts of the code base. You know, things still need to be merged. And I've started doing a bit more of that, just looking around at other parts of the code base, reviewing things that aren't in the wallet, reviewing things that I don't write code for. And so that has, of course, eaten into the amount of time I can spend on the wallet.

99
00:23:20,523 --> 00:23:25,167
Speaker 1: Is spend a pun there? Is that a pun? No. We'll cut that bit.

100
00:23:28,104 --> 00:23:43,969
Speaker 0: So, yeah, it's eaten the amount of time I spend on the wallet. But I still have a plan. I still have things I want to work on. It just takes a little bit longer. I mean, I already knew it would take a long time. So what do you want to work on?

101
00:23:43,989 --> 00:23:44,313
Speaker 1: What's next?

102
00:23:45,000 --> 00:23:53,000
Speaker 0: So what's next? I have like five branches named wallet UTXO set. They're all failed attempts at doing this next thing.

103
00:23:53,666 --> 00:23:54,030
Speaker 1: What is that?

104
00:23:54,050 --> 00:23:54,959
Speaker 0: What's the next thing?

105
00:23:55,765 --> 00:23:57,496
Speaker 2: What is the motivation for that one?

106
00:23:58,240 --> 00:24:36,698
Speaker 0: So the name might not mean a whole lot, but what I want to achieve is to have the wallet actually track its own UTXOs. And by the way, we're wondering, well, it doesn't already do that. It doesn't. So when you ask the wallet, what's my balance? We have some caching. But it will say, let me check every single transaction I've stored. See, look at every single output. Determine, is this output, does this output belong to the wallet? And I will add it to a running total. And it does that with some caching to figure out what's your balance. Does the same thing for what UTXOs are mine and I can spend. It doesn't explicitly maintain a data structure for our UTXOs.

107
00:24:37,160 --> 00:24:40,919
Speaker 2: But every single time you build a transaction, it will recalculate its UTXO pool.

108
00:24:41,040 --> 00:24:49,811
Speaker 0: But that's insane. So for really big wallets, this is kind of problematic. Fortunately, C++ is extremely fast.

109
00:24:52,581 --> 00:24:57,939
Speaker 1: Orinark in this case, unfortunately, because you have to do this ridiculous operation.

110
00:24:58,060 --> 00:25:02,297
Speaker 2: I tried to run a business using Bitcoin Core wallets. Have noticed this problem.

111
00:25:03,643 --> 00:25:06,718
Speaker 0: It used to be worse before there was caching. So we do caching now.

112
00:25:07,000 --> 00:25:08,777
Speaker 1: I don't assume that other wallets run this way.

113
00:25:09,240 --> 00:25:15,200
Speaker 0: Well, I will not say this is like an unreasonable approach for a first implementation. Sure.

114
00:25:15,501 --> 00:25:19,374
Speaker 1: But this is where, you know, Satoshi's been gone for a little bit.

115
00:25:19,394 --> 00:25:53,979
Speaker 0: Interesting. So the next thing I want to do in this rewrite of the wallet is to change how we do UTXO tracking. To actually store UTXOs and to do things where we're also like, we load in a bunch of transactions that are completely irrelevant because every single output's been spent. Or we load in transactions because they exist on disk and maybe they are completely irrelevant. So something that I've been thinking about and working on and off and have had multiple failed attempts at, is to change how we do transaction and UTXO management.

116
00:25:54,765 --> 00:25:55,791
Speaker 1: Sounds like a pretty big swing.

117
00:25:56,255 --> 00:25:56,416
Speaker 0: Yeah.

118
00:25:57,923 --> 00:26:05,000
Speaker 2: So you mentioned to me earlier that in your mind the wallet really consists of three different components. Do you want to elaborate?

119
00:26:05,703 --> 00:26:40,632
Speaker 0: So I think there is the key and script management component. And this is the descriptor wallet kind of stuff. Doing the refactor for descriptor wallets produced a separate component for key and script management. The next part I would say is transaction creation. So this covers like coin selection, just generally how we create transactions, some privacy things. Like do we do anti-fee sniping and what are the users desires for their transaction? Output grouping. Output grouping, all that kind of stuff. And then the last part is transaction storage and management, UTXO management. So wallet history.

120
00:26:41,020 --> 00:26:41,775
Speaker 2: Wallet history, yeah.

121
00:26:42,863 --> 00:26:53,000
Speaker 0: I guess actually there's a fourth part which is just metadata. Address book data, data about comments on transactions, that kind of stuff. But that doesn't seem to be problematic yet.

122
00:26:53,020 --> 00:27:08,000
Speaker 1: I want to return to an earlier theme a little bit. You had said that the wallet in Bitcoin Core was important because you didn't want any barriers for new users running a node. Do we know much about our users? Obviously there's not tracking but you were involved in that MIT study.

123
00:27:08,381 --> 00:27:22,000
Speaker 0: Yeah, there was this spawn from an offhand comment I made to Mesh Collider a couple years ago. I was like, why don't we just run a survey of our users? Post a survey, see what people respond to it. It didn't go as I expected it to go.

124
00:27:22,585 --> 00:27:26,949
Speaker 1: Which is you wanted it to go. It went better than you thought. Not quite.

125
00:27:28,448 --> 00:28:10,959
Speaker 0: How did it go? I don't think we could get very much actionable data out of it. I have posted all, I think I've posted all of the raw data online. So if someone wants to do some analysis on it, they can do that. But I think what ended up happening was that the questions that we asked were probably not that good. And so what we got out of it, garbage in, garbage out. So I don't know if, or when I was looking at it. last time I looked at it, I didn't think that there was much actionable results from it. We did learn a couple things. There are a lot of people who use Bitcoin Core because it is attached to a full node. There are people who use it because they have... Of the respondents of the survey.

126
00:28:11,000 --> 00:28:11,918
Speaker 1: Yeah, of the respondents.

127
00:28:12,682 --> 00:28:37,959
Speaker 0: There are people who use Bitcoin Core because they were using like Spectre and it says use Bitcoin Core. So there's a mix of both of people who want just Bitcoin Core because it's full node and people who are like, I wanted something that was full node and the software I'm using says use Bitcoin Core. So basically... But we didn't really get any data on how people were using the wallet. Although one other thing I did learn is that no one changes their defaults.

128
00:28:38,161 --> 00:28:39,575
Speaker 1: I think that's pretty...

129
00:28:40,464 --> 00:28:41,555
Speaker 0: That's not unexpected.

130
00:28:43,042 --> 00:28:54,939
Speaker 2: So I guess to a degree you could say that wallet development is squeaky wheel gets the oil. When somebody reports an issue we might be like, oh, this is interesting. Maybe we should do something about this.

131
00:28:55,000 --> 00:29:21,000
Speaker 0: Yeah. So a lot of changes have been prompted by people doing something and reporting an issue. Like the reason I actually started looking at transaction management, not because it was inefficient when I read the code. I mean, I noticed that and I was like, cool. But no one's really complained about this yet. And then someone complained about it. And someone with an enormous wallet.

132
00:29:21,381 --> 00:29:25,204
Speaker 1: But there's people complaining about the GUI and the GUI gets no love. So like...

133
00:29:26,646 --> 00:29:27,979
Speaker 0: That's not true. The GUI does.

134
00:29:29,111 --> 00:29:30,000
Speaker 1: Tell me more about the GUI.

135
00:29:30,868 --> 00:29:43,663
Speaker 0: It gets love in a different repo. So we have a separate repo for overhauling the GUI entirely using QML. And that's actually been getting a lot of activity in designing a new interface, designing something that doesn't suck. Right.

136
00:29:44,025 --> 00:29:54,502
Speaker 1: So apparently hot news on this podcast. It will be released within the next two weeks. TM. Yeah. But Harold and team are hard at work. Yes.

137
00:29:54,984 --> 00:30:02,010
Speaker 0: Essentially the GUI redesign is something that has been getting a lot of eyes. The current GUI doesn't. But that's mostly because it's bad, I think.

138
00:30:04,140 --> 00:30:15,000
Speaker 1: But this is the whole point is like, if something's bad and people complain, I've heard like, well, you're just not the right user. You know, drop down to the command line. It'll work great. But then you tell us that it actually doesn't.

139
00:30:15,481 --> 00:30:35,497
Speaker 0: Well, yeah, I don't like responses like that because I don't know if I collected this in the survey, but I think most people who use Bitcoin Core actually like you use it actually as a wallet, use it through the GUI, including myself. Yeah. When I want to use as a wallet, I use it through the GUI because I'm lazy. So having a good user experience in the GUI is important.

140
00:30:36,080 --> 00:31:00,977
Speaker 1: But do you think that'll drastically affect the like the raw number of users that will use it? Or like what is that going to change? Because if people are using Bitcoin Core wallet because it's attached to a full node, making it an amazing user experience, is it really going to outcompete these newfangled wallets that have a big design team and etc., etc.?

141
00:31:02,140 --> 00:31:07,237
Speaker 0: I think it can. Or perhaps the bar is just really low right now.

142
00:31:08,202 --> 00:31:09,939
Speaker 1: That's what we're all striving for.

143
00:31:10,924 --> 00:31:13,939
Speaker 2: I mean, especially for desktop wallets. It's just not that much.

144
00:31:14,120 --> 00:31:59,658
Speaker 0: So if you look at like if you go on like Bitcoin Talk, which I do far more frequently than I should, As long as you're not on Twitter, that's fine. And you look at like what new users are opening new threads about. If they're talking about Bitcoin Core, there's a lot of time it'll be like, how do I do this in Bitcoin Core? And the response is, we got to open the debug console. You got to type these commands in. And it's like, that's not a good user experience. And you're like, OK, how can I? And then they have trouble doing it. And so then the response is, just switch to Electrum or just switch to this other wallet because it's a better user experience. And I think if we can improve the GUI, as I said, the bar is pretty low. So if we can improve the GUI so that people don't feel like they need to switch to a different software in order to use it.

145
00:32:00,040 --> 00:32:17,000
Speaker 1: It just feels like all the elements are there for the big use case, which I think continues to be lacking in the ecosystem. I know there's Sparrow and I know there's Spectre and there's some other solutions out there, Electrum, of course. But a really nice multisig with hardware wallet integration, I think that would be a game changer.

146
00:32:17,562 --> 00:32:25,554
Speaker 0: Yeah, probably. And I think there are some people who have been working on stuff like that. But not necessarily in a nice GUI form.

147
00:32:27,000 --> 00:32:28,272
Speaker 1: Cool. Anything else we want to talk about?

148
00:32:29,000 --> 00:32:57,198
Speaker 2: Maybe the move from legacy wallet to descriptor wallet. There's users that have had their BitTorrent core wallet for a decade. And I know that a recent version had a converter that allows you to convert a legacy wallet to a descriptor wallet. New wallets obviously created by recent versions will be descriptor wallets already. Can you tell us a little bit about that? Yeah. So descriptor wallets, after we did the whole refactor, it turned out, well, because descriptor wallets were so fundamentally different that we had to do the refactor.

149
00:32:58,000 --> 00:33:49,775
Speaker 0: They're just completely incompatible with the old style wallet, which we would call legacy wallets. Legacy is not a great term to be using here. It's used in too many places. Deprecated wallets? I guess. I don't know. But the main thing was we didn't want to break forward compatibility. So if you, in theory, if you take a wallet from 0.2-ish, you can open it in current 24.0. And it will load and it will be missing all of the modern features, but it will still work and you can use that wallet. With descriptor wallets, it's completely different. So if we had a software that was descriptor wallet only and you tried to do that, it would just tell you this wallet, we don't know what this wallet is, and you wouldn't be able to do that. So we wanted to at least make it possible. These people would freak out. Yeah. They would freak out.

150
00:33:50,020 --> 00:33:50,240
Speaker 1: Yeah.

151
00:33:50,260 --> 00:34:27,429
Speaker 0: So there's, so we wanted to have a way to, one, to just convert those kinds of wallets to descriptor wallets after we get rid of the legacy wallet. And then we also want to have a smoothed out deployment timeline. So we start with, okay, we introduce descriptor wallets as a new thing, but it's not the default. Then we change it to the default. Then we say, if you start loading a legacy wallet, we're going to tell you, hey, this thing is deprecated and it's going to go away eventually. And then we say, we upgrade that later to, hey, this thing is deprecated and it's going to go away soon. And then it's, hey, this thing is deprecated, you need to turn on this option to use it. And then it's, hey, this thing doesn't exist anymore.

152
00:34:29,000 --> 00:34:47,073
Speaker 1: And so for that last part, I mean, there's a fundamental Bitcoin philosophy that you should be able to wake up sometime in the future and your money will still be your money. But that seems to be broken here. Not quite. So somewhere in the middle of that is a migration tool, which we've added in 24.0.

153
00:34:49,000 --> 00:35:59,935
Speaker 0: And so the migration tool takes the legacy wallet and converts it entirely into a descriptor wallet so you can continue to use it. When I was writing this tool, one of the things I wanted to do was make sure that this thing can work even after the legacy wallet has been removed. So there's an open PR to replace the database backend that it uses from BDB to a self-written implementation of just a BDB parser. So after we've removed the legacy wallet and you get the error saying, hey, we can't load this anymore, it will also say, but you can migrate it. If you click this button or type this command, we will convert your wallet into a descriptor wallet and you will not be missing anything. You won't be missing anything if you do that. So that's the goal for this whole rollout of descriptor wallets or the plan that is hopefully going to happen soon because developers have been getting increasingly annoyed with BDB. And that conversion tool will stay in the codebase forever? Yeah. So this conversion tool will live in the codebase forever, but it's a very small subset of all the legacy wallet things that it won't be hard to maintain and it can just kind of live in its own couple of files. Got it. So one of the issues with the legacy wallets, for example, is that we simply had a chain of keys and we don't know what output they were used for.

154
00:36:02,000 --> 00:36:28,438
Speaker 2: So each key could be any type of output. And in descriptor wallets, of course, a big advantage is that we store explicitly what output we're generating. So are descriptor wallets more performant then? Sometimes. We don't really have benchmarks for this, so it's hard to say. So one of the things with legacy wallets is that there's no explicitly defined set of scripts that we are watching for.

155
00:36:29,080 --> 00:38:44,000
Speaker 0: And actually, the set was unbounded for a very long time. So there's the obvious ones. So the way that it would work is we would see some script and we'd say, figure out what kind of script is this. Is it PDPKH? Is it PDPKH? Is it PDPKH? Is it P2SH? Or is it a bare multisig? And then we would say, do we have any keys that would match this? So if we got a PDPKH script, we'd be like, do we have any keys whose hash matches this one? And we'd be like, if we do, OK, this is ours. And so actually, that's pretty easy to determine the set of scripts for. You just hash all your keys, right? Same thing for a PDPKH. So we would say, do we have any keys that would match this? And then we would say, do we have any keys that would match this? And so actually, that's pretty easy to determine the set of scripts for. You just hash all your keys, right? Same thing for a P2WPKH and nested P2WPKH. But when you get to bare multisig, so bare multisig is a script. that's just the multisig script, but in an output and not behind a P2SH. And the way we would look at those is, does any of our keys appear in this bare multisig? Do we have enough keys in the bare multisig to sign it? So you could have, I think the standardness is up to three keys, but I believe this would work on any bare multisig that shows up in the blockchain, which is up to 15 keys. And we only need whatever the N number is. So this is literally infinite. You could have one of 15, one of my 1,000 keys is in here, and then have 15 unrelated keys. And our wallet would be like, yep, that's ours. So that turns the set from, okay, we can calculate to just hash all the keys to. it's literally any bare multisig. And this posed a huge problem. And then someone had the foresight of saying that if we wanted bare multisigs, then you had to explicitly import them to your wallet. But this was a breaking change, right? So if you were, for some reason, expecting a bare multisig to be seen by your wallet as belonging to it, and then you upgraded that new version that had this change of required explicit bare multisig import, suddenly those would no longer be yours. But also no one does bare multisig, so it doesn't matter.

156
00:38:45,648 --> 00:38:48,000
Speaker 2: Yeah, because they write the data now to input instead.

157
00:38:48,040 --> 00:39:09,919
Speaker 1: Does any of this matter? I guess we'll, you know. Awesome. Thank you for the discussion. We covered a lot of ground here. Good talking with you. Ha! Cottonhead! All things wallet. I don't know if we can talk about wallets anymore.

158
00:39:10,222 --> 00:39:11,777
Speaker 0: A lot of wallet stuff.

159
00:39:12,301 --> 00:39:20,517
Speaker 2: It feels like, I hope nobody is shocked when they listen to us talking about the Bitcoin Core wallet. There seem to be a lot of construction sites.

160
00:39:21,502 --> 00:39:33,819
Speaker 1: I think when you're so close to something, you see all the flaws. But it's still, I stand by the fact that it has the most review and the highest bar in terms of security.

161
00:39:34,200 --> 00:40:01,979
Speaker 2: I think that it definitely benefits from a lot of the people that actually do use Bitcoin Core wallet, being the Bitcoin Core developers. And frequently when they have some sort of feature they want, they come in and look at it and implement something for it to scratch their own itch. And yeah, so that's I think where we get some of the more unique features and definitely also some of the unique review.

162
00:40:02,744 --> 00:40:10,577
Speaker 1: Cool. Well, I hope you enjoyed the episode. And I think we're going to try to get another one in soon. I don't know. If we start doing them once a week, what happens to us?

163
00:40:11,000 --> 00:40:13,073
Speaker 2: I don't know. People will probably get bored.

164
00:40:15,323 --> 00:40:18,000
Speaker 1: Hopefully not us. All right. We'll see you soon.

