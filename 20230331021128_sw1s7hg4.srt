1
00:00:00,540 --> 00:00:06,119
Speaker 0: Well, I would not say this is like an unreasonable approach for a first implementation.

2
00:00:06,340 --> 00:00:10,677
Speaker 2: Sure, but this is where, you know, Satoshi's been gone for a little bit.

3
00:00:12,210 --> 00:00:19,200
Speaker 0: Interesting. Hey Jonas.

4
00:00:19,440 --> 00:00:23,657
Speaker 2: Hey Murch, we are here with one of your wallet collaborators, H.O.L. 101.

5
00:00:24,482 --> 00:00:25,937
Speaker 1: Well, the wallet guy.

6
00:00:26,402 --> 00:00:28,200
Speaker 2: Yeah, but he's still, you're still a collaborator.

7
00:00:28,640 --> 00:00:29,282
Speaker 0: Sure, sure.

8
00:00:29,643 --> 00:00:37,200
Speaker 1: So Andy has been working on the Bitcoin Core wallet for many years and he's covered a lot of different topics and we're gonna pick his brain on them.

9
00:00:37,801 --> 00:01:00,200
Speaker 2: Descriptor wallets, the big refactor that he did a couple years ago, PSBTs, hardware wallet integration, this migration from legacy wallet to descriptor wallets. Lots to cover, hope you enjoy the episode. So the first question I'm gonna ask you is, why do we need a wallet in Bitcoin Core?

10
00:01:01,064 --> 00:01:04,200
Speaker 0: Well, you gotta make transactions somehow. If we didn't have transactions, we wouldn't have Bitcoin.

11
00:01:04,843 --> 00:01:07,657
Speaker 2: Yeah, but like other people are doing wallets and...

12
00:01:08,240 --> 00:01:09,553
Speaker 1: They're doing it full time.

13
00:01:10,240 --> 00:01:11,614
Speaker 2: Yeah, they got nice gooeys.

14
00:01:12,301 --> 00:01:14,159
Speaker 1: They're building nice features.

15
00:01:15,102 --> 00:01:36,119
Speaker 0: So the Bitcoin Core wallet can be used for some more power usury things. And I guess maybe not the wallet itself, but Bitcoin Core provides a lot of utilities for doing some fairly low level things and some of those are in the wallet. And you can do some weird stuff with your transactions.

16
00:01:36,220 --> 00:01:41,079
Speaker 2: Do we want weird stuff with our transactions to be the value prop of the wallet?

17
00:01:41,280 --> 00:02:09,019
Speaker 0: That's a good point. I guess a good way to look at it is like it's a kind of a research and development product. You use this to do research, you use it to do experimentation. And if you wanted to build a wallet that targets something like a specific type of script, a specific use case, you could start with experimenting on the Bitcoin Core wallet before you move out to whatever targets, whatever specific thing you're trying to target.

18
00:02:09,380 --> 00:02:31,377
Speaker 1: I think generally Bitcoin Core will be on the forefront of what's possible with wallets. Not feature wise, but script wise and protocol wise. So we're working on mini script descriptors. With Create Raw Transaction you can build non-standard transactions, which hardly any wallet can do.

19
00:02:32,803 --> 00:02:35,918
Speaker 2: But again, why is that the value prop?

20
00:02:36,260 --> 00:03:09,079
Speaker 1: I think it's important to have one wallet that shows what's possible for other wallets to make use of that in features. There's a few wallets. For example, a Liana wallet came out recently with an interesting script that I hadn't seen in another wallet yet, which is essentially a decaying multisig where at some point other keys get access to your coins. If you just keep moving your funds about three times a year, it'll remain under your sole control.

21
00:03:09,200 --> 00:03:10,533
Speaker 2: That's the revolt, folks.

22
00:03:11,200 --> 00:03:14,715
Speaker 1: Yes, exactly. So this is like sort of a vaulting mechanism.

23
00:03:15,523 --> 00:03:16,997
Speaker 2: It's actually a dead man's switch kind of thing.

24
00:03:17,200 --> 00:03:17,843
Speaker 0: Yeah, exactly.

25
00:03:18,064 --> 00:03:19,913
Speaker 1: Built in bequesting of your Bitcoins.

26
00:03:21,300 --> 00:03:23,913
Speaker 0: The other thing is, well, Bitcoin Core has always had a wallet.

27
00:03:25,681 --> 00:03:28,751
Speaker 1: There are some people that will not trust other Bitcoins out there.

28
00:03:31,921 --> 00:04:13,200
Speaker 0: Okay, going back to the value proposition thing, there's something to be said for having a wallet that is attached to a full node. And because having your own full node means that it gives you better security, better privacy generally. And so having a wallet that's attached to the full node is what a lot of people want, I think. And part of that, even if you had separate software for this, you've raised the barrier of entry. So if someone wants to have a full node wallet, they might have to, oh, you have to download Bitcoin Core. Then they've got to go find some other wallet, figure out how to connect it to Bitcoin Core, and then they can have their full node wallet. Whereas if you just use Bitcoin Core, then everything's all there for you.

29
00:04:13,842 --> 00:04:26,099
Speaker 1: I mean, there is some wallets that actually do use Bitcoin Core, but I think some of them are on Mac. There are some hardware wallets, but you have to get multiple projects to work together in some fashion.

30
00:04:26,460 --> 00:05:01,838
Speaker 2: Yeah, I guess I'm just confused about who we're catering to. And if I can be so bold as to tell the person who's been working on Bitcoin Core wallet for five years and has made immeasurable contributions to the wallet, the value prop for me is that there's a higher bar for review and security than anywhere else, and that it's more balanced in terms of showing things like privacy and sort of the innovation pieces, like first half SegWit, first half Taproot, et cetera. But the security and soundness principles, you're not going to find anywhere else.

31
00:05:02,280 --> 00:05:14,330
Speaker 0: I'm going to contest you on the ASMR review. Oh, great. Wonderful. I think we should have that. Actually, we've had a few people come in last year and do more on the wallet.

32
00:05:18,322 --> 00:05:27,273
Speaker 1: But for a while, the wallet was definitely a part of the code base that got very little action. But the wallet is hopping right now.

33
00:05:27,636 --> 00:05:58,200
Speaker 0: It's hopping. A little bit. I mean, it's been getting more review, more work on it. But the area that we have, there's always some focus that most contributors are looking at at one time. It's not intentional, but I've noticed this over the years that there'll be a focus on P2P, a focus on validation, a focus on networking, a focus on the wallet. And it moves around. So a couple of years ago, we had a pretty big focus on the wallet, and we've kind of moved off that just naturally.

34
00:05:58,200 --> 00:05:59,614
Speaker 2: What was the big focus a couple of years ago?

35
00:06:00,882 --> 00:06:06,163
Speaker 0: Mostly on the refactor and all the whole thing with descriptor wallets. All right.

36
00:06:06,224 --> 00:06:13,079
Speaker 2: Well, we're going to put a pin in that and come back to it because it's important. But what do you think is the hottest area right now?

37
00:06:13,661 --> 00:06:19,079
Speaker 0: I think right now it's with P2P and transaction relay.

38
00:06:19,567 --> 00:06:22,159
Speaker 2: Mempool. Mempool. So hot right now.

39
00:06:22,481 --> 00:06:27,222
Speaker 0: Mempool. All right.

40
00:06:27,263 --> 00:06:37,396
Speaker 2: So let's go back a couple of years now and talk about the refactor and the descriptor wallet. Go back to the glory days and tell us about what those projects were about.

41
00:06:39,101 --> 00:08:18,200
Speaker 0: So a long time ago at this point, Peter Walla came up with the idea of these output script descriptors. And the point was to have one string that could be used to represent several scripts, all of the scripts in a wallet actually. And here we're using a script to also mean address, they are interchangeable. So you could have a string that contained all the keys, it contained. how to derive those keys, it contained other markers to say like what kind of script to produce and what kind of script probably to produce, which tells us what address we will make. And the goal was to have this in the wallet. A wallet would use these descriptors to produce the addresses. So this would make it really easy to determine what belongs to the wallet. It also makes it a lot easier to upgrade wallets because then you can just say here's a new descriptor and you put it in the wallet and the new descriptor has its definitions will automatically generate all the things. So after Peter had come up with this idea, there was a fork into mini script kind of. And then we started trying to implement it into Bitcoin Core. So this was a fairly big effort. And it turns out that the way that Bitcoin Core was structured was not very good for doing these descriptors. And so before we could even get to that point, we like refactored half of it. And there was a lot of work from myself, from Russ, from Mesh Collider, and then a ton of people were reviewing all of these things, testing it out and experimenting with it. So eventually we got the refactor through and we got the script wallets afterwards, which was also quite a bit of work.

42
00:08:20,223 --> 00:08:40,918
Speaker 2: And I guess looking back on that, first of all, those are two big efforts from someone who, you know, you had been you had had contributions before, but not led anything like that. Can you tell us what that process was like? It was like leading those giant efforts. I remember when that sort of like gist of this is what the refactor is going to look like came out. Like, well, that's it looks like a lot of work. And I was right.

43
00:08:41,461 --> 00:09:12,979
Speaker 0: Yeah. That also was like. I think it was also the third attempt to get the script wallets through. So we have these core dev in-person events and a lot of the discussion around how we were going to do it ended up taking place during a couple of those, like multiple of them. So this was spread out over quite a while. I guess like it wasn't even that I wanted to lead the project or like lead this effort. I found it interesting. And then I just wrote it and being the one to write something ends up putting you in charge of it.

44
00:09:14,161 --> 00:09:15,483
Speaker 2: So it sure does.

45
00:09:17,086 --> 00:09:31,939
Speaker 0: So, so like I wrote the PR, I wrote a couple of different branches and eventually one of them became a PR and people started reviewing and giving comments. And then like, that's basically how I ended up in charge of this whole effort is because I went through the effort of writing it.

46
00:09:32,220 --> 00:09:36,072
Speaker 1: I think was that before or after you were nominated for wallet maintainer.

47
00:09:36,614 --> 00:09:37,437
Speaker 0: That was long before that.

48
00:09:38,200 --> 00:09:39,462
Speaker 2: This is like, this is like 2018, 2019, something like that.

49
00:09:39,522 --> 00:09:41,567
Speaker 0: Oh, two years ago. Yeah, two years ago.

50
00:09:47,902 --> 00:10:09,858
Speaker 2: For those who can't see us at home, it's that was those are air quotes. OK, so you did the refactor. You got the scripture wallets in. Are you happy with where things are at? I mean, I disagree in terms of you're not getting attention. There's the guy sitting at the table with us. There's Fursy, there's Josie. What else do you want, man?

51
00:10:10,340 --> 00:10:19,558
Speaker 0: Well, OK, when I started doing that refactor, I eventually realized actually the way the wallet as it is currently written is kind of really not that great.

52
00:10:20,200 --> 00:10:23,079
Speaker 2: OK, so the refactor ended up not being that great.

53
00:10:23,440 --> 00:10:39,557
Speaker 0: No, like like the just in doing the refactor, I learned a lot about how I see the wallet itself actually works. And and in doing that, I it occurred to me that actually this code is not that good. And well, part of it is that you can trace a significant portion of it back to Satoshi.

54
00:10:40,260 --> 00:10:41,505
Speaker 2: How does he know how to write code?

55
00:10:42,951 --> 00:11:35,200
Speaker 0: This is not the not the highest quality of code. And, you know, it makes it hard to implement new changes and is also not very performant. So around that time, I also had the idea of, well, why don't we just rewrite this thing? This is not a new idea. Actually, if you look at our IRC meetings, this meme has come up multiple times over many years of why don't we just rewrite the wallet? Actually, at some point, I think it became why don't we just delete the wallet? Because it was getting that hard to work with. And the change to the descriptor wallets ended up rewriting, I would say, probably like a third of the wallet. And so there's still two thirds I'm looking at wanting to do. But there just doesn't seem like the appetite. Yeah. The appetite for reviewers to look at these changes and to go through with a lot of the things involved in doing this kind of rewrite.

56
00:11:35,260 --> 00:11:37,918
Speaker 2: And what do you think that other two third rewrite will get us?

57
00:11:38,681 --> 00:12:18,159
Speaker 1: So I looked the first time really at the wallet in 2014 when I got interested in coin selection. And you could probably pretty easily still figure out that all of Bitcoin was a part of a single file at some point, almost. It all came out of main.cpp and people had then pulled out a few things. For example, the coin selection stuff had not really been touched since 2011. Somebody introduced an app sack then. before that, I think it was just either largest first selection or oldest first selection. No, it used all UTXOs for every transaction. Yes, at some point it used all UTXOs for every transaction.

58
00:12:18,220 --> 00:12:20,179
Speaker 0: I don't remember this. I know...

59
00:12:20,763 --> 00:12:22,455
Speaker 2: Guy has a master's thesis, I wouldn't mess with him.

60
00:12:24,062 --> 00:12:41,999
Speaker 0: The very first version of Bitcoin chose coins by TXID order. It used a standard map, which is a sorted data structure, and it was sorted by TXID. So it would take the first thing out of standard map. It wasn't enough to take the second one, the third one, and so on.

61
00:12:43,513 --> 00:12:44,200
Speaker 2: Seems very efficient.

62
00:12:44,684 --> 00:12:47,526
Speaker 0: Oh, it was very fast. I'm sure it's very fast. Quite performant.

63
00:12:48,029 --> 00:12:50,200
Speaker 2: You're recusing Satoshi not being performant.

64
00:12:51,285 --> 00:12:54,200
Speaker 0: But it's not very good for fee optimization, like anything else.

65
00:12:54,280 --> 00:13:12,855
Speaker 1: Yeah, anyway, somebody put in knapsack. Knapsack is terrible. We still have knapsack. And then I think Alex Morkos fixed something about the looping behavior after my master thesis, and then nobody touched that part of the wallet until 2018.

66
00:13:14,422 --> 00:13:38,079
Speaker 0: Until 2017, something like that. So the way that we did coin selection changes was people would use it. They would find, oh, there's this really weird behavior if you do this one really specific thing. And you'd be like, okay, we will fix that thing. Here's an if statement for some wild condition that you probably shouldn't hit, but it's there, and it resolves this problem. And that's how we did coin selection. It was completely ad hoc.

67
00:13:38,260 --> 00:13:41,119
Speaker 2: Sounds like an elegant solution. What could go wrong?

68
00:13:41,361 --> 00:14:11,878
Speaker 0: Yeah, it was just completely ad hoc. And there was no overall, like, what do we want coin selection to do? What are we trying to target with it? What kind of coins do we want? What fee rates? All that stuff. None of that was really in consideration, I think. And it was mostly just like, here's a thing that we inherited from people who wrote something several years ago, and now it doesn't work. It's completely black magic. We don't know why it doesn't work. We don't know what the hell it's actually doing. And we're just going to throw some special case in for this one broken behavior.

69
00:14:12,220 --> 00:14:24,159
Speaker 2: Yeah, so one of the things that I think seems to have helped with some of that is you have recently done some simulation work so that you can actually simulate some of this behavior. So tell me more about that project.

70
00:14:25,364 --> 00:14:47,200
Speaker 0: So this started when I was interning at Blockstream in 2017. And one of my projects then was to implement Merger's coin selection algorithm in Bitcoin Core. And of course, because coin selection was at that time just a black box, no one knew how it actually worked, there was a question of, well, can you demonstrate that this is better for some definition of better? that is still undefined?

71
00:14:48,205 --> 00:14:53,273
Speaker 2: So I wrote a whole thesis about that. What's the framework of better then?

72
00:14:54,703 --> 00:15:19,959
Speaker 1: Well, there's different metrics that you could use. Mine was what is the overall fee cost and how healthy is the wallet in the end, as in if you keep fragmenting your wallet more and more, your long-term fees that you have essentially, for every UTXO that you have in your wallet, you will have to spend money in the future to spend it. So the more fragmented your wallet is, the more future costs you have already locked in.

73
00:15:20,220 --> 00:15:27,819
Speaker 2: But there are other metrics associated with that. So for example, just like a human, be like, well, my cholesterol is high, but my pulse is good. Am I healthy?

74
00:15:28,200 --> 00:15:28,503
Speaker 0: Who knows?

75
00:15:30,240 --> 00:15:43,179
Speaker 1: So I mean, not that strictly where you can look at a single number and you can say, oh, my health square is like that. But we found ways to compare different approaches and see which one is better.

76
00:15:43,200 --> 00:15:46,275
Speaker 2: And are those being integrated into our criteria?

77
00:15:47,842 --> 00:16:18,175
Speaker 1: The waste metric is kind of an aggregate of all of these. The waste metric is one of these. with Jose I've been talking about on and off about how the waste metric should only be one of multiple things that contribute to the score. And we would like to have some scoring mechanism for privacy as a second contributor to which inputs we select. So I don't think it's been our focus yet, but we've been bouncing around some ideas. With coin selection, I think, well, so I ended up using a lot of Merges stuff because he was the only one who actually seemed to know anything about coin selection.

78
00:16:20,200 --> 00:16:30,705
Speaker 0: There was a master's thesis. That's why we hired him. I thought it was for my Stack Exchange answers. Yeah.

79
00:16:32,320 --> 00:16:34,210
Speaker 2: So in 2017, I implemented the coin selection.

80
00:16:36,240 --> 00:17:09,281
Speaker 0: Yeah. So in 2017, I implemented the Merges algorithm, which we call branch and bound. And then in doing that, learned about how coin selection works and doesn't work and realized how our coin selection algorithm was not that good. And this also led to another refactor that ended up being delayed quite a long time just to clean up coin selection and get rid of some other dumb behavior that we had in it. Yeah.

81
00:17:10,320 --> 00:17:35,057
Speaker 2: So you've taken on us on this tour of getting to coin selection and talking about, you know, simulated behavior, which gives us actually some criteria to compare against, which seems like a good idea. But these aren't your only projects. You've also been thinking about, like, you led the effort on PSBTs. There's hardware integration. How do these all fit together?

82
00:17:35,661 --> 00:17:46,312
Speaker 0: At some point, I got a hardware wallet and I was like, why can't I use this with Bitcoin Core? Turns out because it's very hard.

83
00:17:48,420 --> 00:18:20,139
Speaker 1: So basically you were saying, hey, I want to be able to transfer a unsigned transaction between one device and another device, and I need a standardized format for that. And it turns out that introducing a format for talking about unsigned or half-signed or partially-signed transactions is something that a lot of people actually also need and have implemented before, but having a single standard for it was pretty awesome. And down the road, what it makes much, much easier is multi-party transactions.

84
00:18:20,608 --> 00:18:42,018
Speaker 0: Yeah. So I wrote HWI as mostly just a toy for experimentation. So Trezor provided a Python library, so I wrote it in Python. Which I really enjoyed. Yeah, it was a brilliant idea. Ledger also provided a Python library. And then what was the other one I had at the time?

85
00:18:42,383 --> 00:18:42,771
Speaker 1: Coldcard?

86
00:18:43,342 --> 00:20:10,919
Speaker 0: No, that didn't exist yet. DigitalBitBox. They had a really simple protocol that I could implement in Python. And there might have also been a Python library. So I did it all in Python, mostly for myself. And I found out that, OK, I can get a thing that Bitcoin Core can watch, but how do I get transactions out of Bitcoin Core into this script and get that to all the devices, including all the other information that they need to sign? And that stuff includes, well, for each of those devices, they have different protocols. So you now need to take it in some common format that can give to my program. That needs to convert it into all these other protocols that I can send out to the device. And then recombine it. And it all has to come back out and go the other way into Bitcoin Core. So it turns out that in doing that, I decided to write PSBT as that common data format to transfer information from Bitcoin Core to HWI. And so these two projects were PSBT and HWI were intrinsically linked from the start. And of course, it turns out that a way to transfer data about transactions to be signed between two different pieces of software is actually really useful, even if one end is not a hardware wallet. Because all of that hardware wallet signing stuff is abstracted away. So being able to have something that I can pass around between different compatible software was really useful for the ecosystem.

87
00:20:11,401 --> 00:20:17,179
Speaker 2: And then besides sort of the implicit, it's useful. What other things are using this kind of thing?

88
00:20:17,240 --> 00:20:48,179
Speaker 0: The other thing is like multi-party transactions, because we can just the way that I had written it. And this was also kind of on my mind when I was doing it, but allows us to do things like multi-sigs or coin-joints. Yeah. Anything that required having multiple people involved was made easier by having PSBT because now it was a common data format that contained all the information you needed to know in order to sign it, except for the private keys, obviously. And so you can just pass around to everyone, they can sign it, and it just makes life a lot easier.

89
00:20:48,620 --> 00:21:08,179
Speaker 1: And then now on the other side of this equation, of course, wallets started saying, hey, wait, there is a shared format for talking about partially signed Bitcoin transactions. And now the hardware wallets and other wallets are implementing that, and we get a global standard in how wallets can communicate with each other.

90
00:21:08,360 --> 00:21:26,718
Speaker 0: And one thing I found was that the idea of having a format containing information that you need in order to sign is not new. There was a BIP 10, something like that. It was very old. That did something similar to PSBT, but not quite, and it ended up being withdrawn for some reason.

91
00:21:27,321 --> 00:21:27,725
Speaker 2: Who wrote it?

92
00:21:29,280 --> 00:22:05,213
Speaker 0: The armory guy, Alan Reiner. Someone pointed this out to me. I was like, oh, I just didn't realize this existed. I read it. It's not the same, and it was missing a bunch of things, I think. But this is not new. Electrum had their own custom format. Bitcoin Core did a thing where it would shove signatures into the raw transaction. I mean, BitGo had its own format, too. And Capo had their own format, just like internal use. And no one ever thought to standardize it until I came along and wrote my own thing. I was like, you know, maybe this would be useful for everyone else.

93
00:22:06,802 --> 00:22:15,818
Speaker 2: It's clear that you've developed this affinity for the wallet. Merch already mentioned it. You became a maintainer within the last, it's been about a year, right? December?

94
00:22:16,220 --> 00:22:16,907
Speaker 0: Yeah, I think so.

95
00:22:18,200 --> 00:22:34,515
Speaker 2: So has that changed things for you? Has it changed things, how you approach the wallet, how you think about its future? I think the reason I love this idea around maintainership is it's not like an explicit lead, but it often goes to the person who's most active in that area. So how does that change things for you?

96
00:22:35,962 --> 00:23:19,898
Speaker 0: It doesn't change a whole lot in terms of the things that I want to do. It changes how much time I have to do them. So since I've became a maintainer, I've been doing a lot more review. And not just the wallet stuff, because we know, like, I mean, recently, relatively recently, both Peter and Vladimir have stepped down as maintainers. And we do need maintainers to look at all parts of the code base. You know, things still need to be merged. And I've started doing a bit more of that just looking around at the other parts of the code base, reviewing things that aren't in the wallet, reviewing things that I don't write code for. And so that has, of course, eaten into the amount of time I can spend on the wallet.

97
00:23:20,501 --> 00:23:25,159
Speaker 2: Is spend a pun there? Is that a pun? We'll cut that bit.

98
00:23:28,103 --> 00:23:53,059
Speaker 0: So, yeah, it's eaten into the amount of time I work, I spend on the wallet. But I still have a plan. I still have things I want to work on. It just takes a little bit longer. I mean, I already knew it would take a long time. So what do you want to work on? What's next? So what's next? I have, like, five branches named wallet UTXO set. They're all failed attempts at doing this next thing.

99
00:23:53,465 --> 00:23:55,446
Speaker 2: What is that? So what's the next thing?

100
00:23:55,767 --> 00:23:57,496
Speaker 1: What is the motivation for that one?

101
00:23:58,240 --> 00:24:36,179
Speaker 0: So the name might not mean a whole lot, but what I want to achieve is to have the wallet actually track its own UTXOs. And by wondering, well, it doesn't already do that. It doesn't. So when you when you ask the wallet, what's my balance? We have some caching, but it will say, let me check every single transaction I've stored. See, look at every single output. Determine is this output? does this output belong to the wallet and I will add it to a running total. And it does that with some caching to figure out what's your balance. does the same thing for what UTXOs are mine and I can spend. It doesn't explicitly maintain a data structure for our UTXOs.

102
00:24:36,861 --> 00:24:43,179
Speaker 1: But every single time you build a transaction, it will recalculate its UTXO pool for all the history of the wallet.

103
00:24:44,382 --> 00:24:49,816
Speaker 0: So for really big wallets, this is kind of problematic. Fortunately, C++ is extremely fast.

104
00:24:52,584 --> 00:24:56,537
Speaker 2: Orinorck in this case, unfortunately, because you have to do this ridiculous operation.

105
00:24:57,461 --> 00:25:02,200
Speaker 1: People that try to run a business using Bitcoin Core wallets have noticed this problem.

106
00:25:03,687 --> 00:25:06,059
Speaker 0: It used to be worse before there was caching. So we do caching now.

107
00:25:06,220 --> 00:25:08,200
Speaker 2: I don't assume that other wallets run this way.

108
00:25:09,243 --> 00:25:15,222
Speaker 0: Well, I will not say this is like an unreasonable approach for a first implementation. Sure.

109
00:25:15,503 --> 00:25:19,374
Speaker 2: But this is where, you know, Satoshi has been gone for a little bit.

110
00:25:19,394 --> 00:25:54,179
Speaker 0: Interesting. So the next thing I want to do in this rewrite of the wallet is to change how we do UTXO tracking to actually store UTXOs and to do things where like we were also like we load in a bunch of transactions that are completely irrelevant because every single output has been spent. Or we load in transactions because they exist on disk and maybe they are completely irrelevant. So something that I've been thinking about and working on and off and have had multiple failed attempts at is to change how we do transaction and UTXO management.

111
00:25:54,765 --> 00:25:55,755
Speaker 2: Sounds like a pretty big swing.

112
00:25:56,220 --> 00:25:56,404
Speaker 0: Yeah.

113
00:25:57,921 --> 00:26:05,200
Speaker 1: So you mentioned to me earlier that in your mind, the wallet really consists of three different components. Do you want to elaborate?

114
00:26:05,701 --> 00:26:40,518
Speaker 0: So I think there is the key and script management component. And this is the descriptor wallet kind of stuff. Doing the refactor for descriptor wallets like produced a separate component for key and script management. The next part I would say is transaction creation. So this covers like coin selection, just generally how we create transactions, some privacy things like. do we do anti-fee sniping and, you know, what are the users desires for their transaction? Output grouping. Output grouping, all that kind of stuff. And then the last part is transaction storage and management, UTXO management.

115
00:26:41,200 --> 00:26:41,648
Speaker 1: Wallet history.

116
00:26:42,200 --> 00:26:53,099
Speaker 0: Wallet history, yeah. I guess there actually there's a fourth part which is metadata. Like address book data, data about like comments on transaction, that kind of stuff. But that's not. that doesn't seem to be problematic yet.

117
00:26:53,661 --> 00:27:08,200
Speaker 2: I want to return to an earlier theme a little bit. You had said that the wallet in Bitcoin Core was important because you didn't want any barriers for new users running a node. Do we know much about our users? Obviously there's not tracking, but you were involved in that MIT study.

118
00:27:08,380 --> 00:27:22,139
Speaker 0: Yeah, there was this spawn from an offhand comment I made to Mesh Collider a couple years ago. I was like, why don't we just like run a survey of our users, like post a survey, see what people respond to it. Didn't go as I expected it to go.

119
00:27:22,582 --> 00:27:26,937
Speaker 2: Which is you wanted it to go. It went better than you thought. Not quite.

120
00:27:27,260 --> 00:28:38,200
Speaker 0: How did it go? I don't think we could get very much actionable data out of it. I have posted all, I think I've posted all of the raw data online. So if someone wants to do some analysis on it, they can do that. But I think what ended up happening was that the questions that we asked were probably not that good. And so what we got out of it, garbage in, garbage out. So I don't know if, or when I was looking at it. last time I looked at it, I didn't think that there was much actionable results from it. We did learn a couple things. Like there are a lot of people who use Bitcoin Core because it is attached to a full node. There are people who use it because they have- Of the respondents of the survey. Yeah, of the respondents. There are people who use Bitcoin Core because they were using like Spectre and it says, use Bitcoin Core. So there's a mix of both of people who want just Bitcoin Core because it's full node and people who are like, I wanted something that was full node and the software I'm using said, use Bitcoin Core. So basically- But we didn't really get any data on how people were using the wallet. Although one other thing I did learn is that no one changes their defaults.

121
00:28:38,907 --> 00:28:42,351
Speaker 2: I think that's pretty- But that's like- That's not unexpected.

122
00:28:44,062 --> 00:28:54,422
Speaker 1: I guess to a degree you could say that wallet development is squeaky wheel gets the oil. When somebody reports an issue we might be like, oh, this is interesting. Maybe we should do something about this. Yeah.

123
00:28:56,581 --> 00:29:20,159
Speaker 0: So a lot of changes have been prompted by people doing something and reporting an issue. The reason I actually started looking at transaction management, not because it was inefficient. when I read the code. I mean, I noticed that I was like, cool. But no one's really complained about this yet. And then someone complained about it. And someone with an enormous wallet.

124
00:29:20,340 --> 00:29:25,200
Speaker 2: But there's people complaining about the GUI and the GUI gets no love.

125
00:29:25,261 --> 00:29:28,038
Speaker 0: So like- That's not true. The GUI does.

126
00:29:29,109 --> 00:29:30,179
Speaker 2: Tell me more about the GUI.

127
00:29:30,866 --> 00:29:43,682
Speaker 0: It gets love in a different repo. So we have a separate repo for overhauling the GUI entirely using QML. And that's actually been getting a lot of activity in designing a new interface, designing something that doesn't suck. Right.

128
00:29:44,024 --> 00:29:49,938
Speaker 2: So apparently hot news on this podcast. It will be released within the next two weeks. TM.

129
00:29:50,705 --> 00:29:51,109
Speaker 0: Yeah.

130
00:29:52,200 --> 00:29:54,481
Speaker 2: But Harold and team are hard at work at this. Yes.

131
00:29:54,983 --> 00:30:02,012
Speaker 0: Essentially the GUI redesign is something that has been getting a lot of eyes. The current GUI doesn't. But that's mostly because it's bad, I think.

132
00:30:04,143 --> 00:30:15,200
Speaker 2: But this is the whole point is like, if something's bad and people complain, I've heard like, well, you're just not the right user. You know, drop down to the command line. It'll work great. But then you tell us that it actually doesn't.

133
00:30:15,480 --> 00:30:35,436
Speaker 0: Well, yeah, I don't like responses like that because I don't know if I collected this in the survey, but I think most people who use Bitcoin Core actually like you use it actually as a wallet, use it through the GUI, including myself. When I want to use as a wallet, I use it through the GUI because I'm lazy. So having a good user experience in the GUI is important.

134
00:30:36,420 --> 00:31:00,979
Speaker 2: But do you think that'll drastically affect the like the raw number of users that will use it? Or like what is that going to change? Because if people are using Bitcoin Core wallet because it's attached to a full node, making it an amazing user experience. Is it really going to outcompete these newfangled wallets that have a big design team and etc., etc.?

135
00:31:01,381 --> 00:31:07,236
Speaker 0: I think it can. Or perhaps the bar is just really low right now.

136
00:31:08,462 --> 00:31:09,937
Speaker 2: That's what we're all striving for.

137
00:31:10,923 --> 00:31:14,139
Speaker 1: I mean, especially for desktop wallets, there's just not that much there.

138
00:31:14,200 --> 00:31:21,179
Speaker 0: So if you look at like if you go on like Bitcoin Talk, which I do far more frequently than I should, and you look at like...

139
00:31:21,200 --> 00:31:22,957
Speaker 2: As long as you're not on Twitter, that's fine.

140
00:31:24,083 --> 00:31:59,179
Speaker 0: And you look at like what new users are opening new threads about. If they're talking about Bitcoin Core, there's a lot of time it'll be like, how do I do this in Bitcoin Core? And the response is, we got to open the debug console. You got to type these commands in. And it's like, that's not a good user experience. And you're like, OK, how can I... And then they have trouble doing it. And so then the response is, just switch to Electrum or just switch to this other wallet because it's a better user experience. And I think if we can improve the GUI, as I said, the bar is pretty low. So if we can improve the GUI so that people don't feel like they need to switch to a different software in order to use it...

141
00:31:59,220 --> 00:32:17,059
Speaker 2: It just feels like all the elements are there for the big use case, which I think continues to be lacking in the ecosystem. I know there's Sparrow and I know there's Spectre and there's some other solutions out there, Electrum, of course. But a really nice multisig with hardware wallet integration, I think that would be a game changer.

142
00:32:17,567 --> 00:32:25,340
Speaker 0: Yeah, probably. And I think there are some people who have been working on stuff like that, but not necessarily in a nice GUI form. Cool.

143
00:32:25,441 --> 00:32:28,038
Speaker 2: Anything else we want to talk about?

144
00:32:28,763 --> 00:32:51,861
Speaker 1: Maybe the move from legacy wallet to descriptor wallet. There's users that have had their Bitcoin Core wallet for a decade. And I know that a recent version had a converter that allows you to convert a legacy wallet to a descriptor wallet. New wallets obviously created by recent versions will be descriptor wallets already. Can you tell us a little bit about that? Yeah.

145
00:32:52,983 --> 00:34:30,837
Speaker 0: So descriptor wallets, after we did the whole refactor, it turned out, well, because descriptor wallets were so fundamentally different that we had to do the refactor. They're just completely incompatible with the old style wallet, which we would call legacy wallets. Legacy is not a great term to be using here. It's used in too many places. Deprecated wallets? I guess. I don't know. But the main thing was we didn't want to break forwards compatibility. So if you, in theory, if you take a wallet from 0.2-ish, you can open it in current 24.0. And it will load and it will be missing all of the modern features, but it will still work and you can use that wallet. With descriptor wallets, it's completely different. So if we had a software that was descriptor wallet only and you tried to do that, it would just tell you, this wallet, we don't know what this wallet is. And you wouldn't be able to do that. So we wanted to at least make it possible. People would freak out. Yeah. They would freak out. Yeah. So we wanted to have a way to, one, to just convert those kinds of wallets to descriptor wallets after we get rid of the legacy wallet. And then we also want to have a smoothed out deployment timeline. So we start with, OK, we introduce descriptor wallets as a new thing, but it's not the default. Then we change it to the default. Then we say, if you start loading a legacy wallet, we're going to tell you, hey, this thing is deprecated and it's going to go away eventually. And then we say, we upgrade that later to, hey, this thing is deprecated and it's going to go away soon. And then it's, hey, this thing is deprecated. You need to turn on this option to use it. And then it's, hey, this thing doesn't exist anymore.

146
00:34:31,841 --> 00:34:44,918
Speaker 2: And so for that last part, I mean, there's a fundamental Bitcoin philosophy that you should be able to wake up sometime in the future and your money will still be your money. But that seems to be broken here.

147
00:34:45,281 --> 00:35:44,879
Speaker 0: Not quite. So somewhere in the middle of that is a migration tool, which we've added in 24.0. And so the migration tool takes the legacy wallet and converts it entirely into a descriptor wallet so you can continue to use it. When I was writing this tool, one of the things I wanted to do was make sure that this thing can work even after the legacy wallet has been removed. So there's an open PR to replace the database backend that it uses from BDB to a self-written implementation of just a BDB parser. So after we've removed the legacy wallet and you get the error saying, hey, we can't load this anymore, it will also say, but you can migrate it. If you click this button or type this command, we will convert your wallet into a descriptor wallet and you will not be missing anything. You won't be missing anything if you do that. So that's like the goal for this whole rollout of descriptor wallets or like the plan that is hopefully going to happen soon because we're getting, developers have been getting increasingly annoyed with BDB.

148
00:35:45,441 --> 00:35:48,119
Speaker 2: And that conversion tool will stay in the codebase forever?

149
00:35:48,240 --> 00:36:00,200
Speaker 0: Yeah. This conversion tool will live in the codebase forever, but it's like a very small subset of all the legacy wallet things that it won't be hard to maintain. And it can just kind of live in its own couple of files.

150
00:36:00,689 --> 00:36:24,938
Speaker 1: Got it. So one of the issues with the legacy wallets, for example, is that we simply had a chain of keys and we don't know what output they were used for. So each key could be any type of output. And in descriptor wallets, of course, a big advantage is that we store explicitly what output we're generating. So are descriptor wallets more performant then?

151
00:36:25,523 --> 00:38:44,079
Speaker 0: Sometimes. We don't really have benchmarks for this, so it's hard to say. So one of the things with legacy wallets is that there was no, there's no like explicitly defined set of scripts that we are watching for. And actually the set was unbounded for a very long time. So there's the obvious ones like, so the way that it would work is we would see some script and we say figure out what kind of script is this? Like is it P2PKH, is it P2WPKH, is it P2SH, or is it a bare multisig? And then we would say, do we have any keys that would match this? So if we got like a P2PKH script, we'd be like, do we have any keys whose hash matches this one? And be like, if we do, okay, this is ours. And so that actually, that's pretty easy to determine the set of scripts for. You just hash all your keys, right? Same thing for P2WPKH and nested P2WPKH. But when you get to bare multisig, so bare multisig was, is a script. that's just the multisig script, but in an output and not behind a P2SH. And the way we would look at those is, does any of our keys appear in this bare multisig? And then do we have enough keys, do we have enough keys in the bare multisig to sign it? So you could have, I think the standardness is up to three keys, but I believe this would work on any bare multisig that shows up in the blockchain, which is up to 15 keys. And we only need whatever the N number is. So this is literally infinite. You could have one of 15, one of my thousand keys is in here, and then have 15 unrelated keys. And our wallet would be like, yep, that's ours. So that turns the set from, okay, we can calculate to just hash all the keys to it's literally any bare multisig. And this posed a huge problem. And then someone had the foresight of saying that if we wanted bare multisigs, then you had to explicitly import them to your wallet. But this was a breaking change, right? So if you were, for some reason, expecting a bare multisig to be seen by your wallet as belonging to it, and then you upgraded that new version that had this change of required explicit bare multisig import, suddenly those would no longer be yours. But also, no one does bare multisig, so it doesn't matter.

152
00:38:45,647 --> 00:38:48,159
Speaker 1: Yeah, because they write the data now to input instead.

153
00:38:48,401 --> 00:39:09,918
Speaker 2: Does any of this matter? I guess we'll, you know. Awesome. Thank you for the discussion. We covered a lot of ground here. Good talking with you. Hot, hot in here. All things wallet. I don't know if we can talk about wallets anymore.

154
00:39:10,220 --> 00:39:11,795
Speaker 0: A lot of wallet stuff.

155
00:39:12,300 --> 00:39:21,179
Speaker 1: It feels like, I hope nobody is shocked when they listen to us talking about the Bitcoin Core wallet. There seem to be a lot of construction sites.

156
00:39:21,501 --> 00:39:33,819
Speaker 2: I think when you're so close to something, you see all the flaws. But it's still, I stand by the fact that it has the most review and the highest bar in terms of security.

157
00:39:34,200 --> 00:39:57,200
Speaker 1: I think that it definitely benefits from a lot of the people that actually do use Bitcoin Core wallet, being the Bitcoin Core developers. And frequently when they have some sort of feature they want, they come in and look at it and implement something for it to scratch their own itch. And yeah, so that's I think where we get some of the more unique features and definitely also some of the unique review.

158
00:40:02,742 --> 00:40:10,576
Speaker 2: Cool. Well, I hope you enjoyed the episode. I don't know, if we start doing them once a week, what happens to us?

159
00:40:11,220 --> 00:40:13,072
Speaker 1: I don't know. People will probably get bored.

160
00:40:15,327 --> 00:40:18,210
Speaker 2: Hopefully not us. All right, we'll see you soon.

