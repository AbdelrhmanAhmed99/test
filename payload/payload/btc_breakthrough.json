{"date": "12/9/2022", "title": "btc_breakthrough", "url": "https://anchor.fm/s/12fe0620/podcast/play/66272115/https://d3ctxlq1ktw2nl.cloudfront.net/staging/2023-2-10/3aec2280-957d-3f13-b373-37ecf993c057.mp3", "body": "\ufeff1\n00:00:00,540 --> 00:00:06,060\nSpeaker 0: Well, I would not say this is like an unreasonable approach for a first implementation.\n\n2\n00:00:06,820 --> 00:00:10,713\nSpeaker 2: Sure, but this is where, you know, Satoshi's been gone for a little bit.\n\n3\n00:00:12,218 --> 00:00:12,600\nSpeaker 0: Interesting.\n\n4\n00:00:17,445 --> 00:00:18,070\nSpeaker 1: Hey Jonas.\n\n5\n00:00:19,480 --> 00:00:23,657\nSpeaker 2: Hey Murch. We are here with one of your wallet collaborators, H.O.L. 101.\n\n6\n00:00:24,641 --> 00:00:25,939\nSpeaker 1: Well, the wallet guy.\n\n7\n00:00:26,400 --> 00:00:28,220\nSpeaker 2: Yeah, but he's still, you're still a collaborator.\n\n8\n00:00:28,641 --> 00:00:37,579\nSpeaker 1: Sure, sure. So Andy has been working on the Bitcoin Core wallet for many years, and he's covered a lot of different topics, and we're going to pick his brain on them.\n\n9\n00:00:37,980 --> 00:01:00,300\nSpeaker 2: Descriptor wallets, the big refactor that he did a couple years ago, PSBT's hardware wallet integration, this migration from legacy wallet to descriptor wallets. Lots to cover. Hope you enjoy the episode. So the first question I'm going to ask you is, why do we need a wallet in Bitcoin Core?\n\n10\n00:01:01,060 --> 00:01:04,379\nSpeaker 0: Well, you got to make transactions somehow. If we didn't have transactions, we wouldn't have Bitcoin.\n\n11\n00:01:05,040 --> 00:01:07,459\nSpeaker 2: Yeah, but like other people are doing wallets.\n\n12\n00:01:08,320 --> 00:01:09,559\nSpeaker 1: They're doing it full time.\n\n13\n00:01:10,220 --> 00:01:11,617\nSpeaker 2: Yeah, they got nice gooeys.\n\n14\n00:01:12,440 --> 00:01:14,179\nSpeaker 1: They're building nice features.\n\n15\n00:01:15,540 --> 00:01:36,040\nSpeaker 0: So the Bitcoin Core wallet can be used for some more power usury things. And I guess maybe not the wallet itself, but Bitcoin Core provides a lot of utilities for doing some fairly low level things. And some of those are in the wallet. And you can do some weird stuff with your transactions.\n\n16\n00:01:36,240 --> 00:01:41,440\nSpeaker 2: Do we want weird stuff with our transactions to be the value prop of the wallet?\n\n17\n00:01:42,120 --> 00:02:09,019\nSpeaker 0: That's a good point. I guess a good way to look at it is like it's a kind of a research and development product. You use this to do research, use it to do experimentation. And if you wanted to build a wallet that targets something like a specific type of script, a specific use case, you could start with experimenting on the Bitcoin Core wallet before you move out to whatever targets, whatever specific thing you're trying to target.\n\n18\n00:02:09,381 --> 00:02:31,379\nSpeaker 1: I think generally Bitcoin Core will be on the forefront of what's possible with wallets. Not feature wise, but script wise and protocol wise. So we're working on mini script descriptors. With Create Raw Transaction, you can build non-standard transactions, which hardly any wallet can do.\n\n19\n00:02:32,840 --> 00:02:35,899\nSpeaker 2: But again, why is that the value prop?\n\n20\n00:02:36,080 --> 00:03:09,059\nSpeaker 1: I think it's important to have one wallet that shows what's possible for other wallets to make use of that in features. There's a few wallets. For example, a Liana wallet came out recently with an interesting script that I hadn't seen in another wallet yet, which is essentially a decaying multisig where at some point other keys get access to your coins. But if you just keep moving your funds about three times a year, it'll remain under your sole control.\n\n21\n00:03:09,280 --> 00:03:10,559\nSpeaker 2: That's the revolt, folks.\n\n22\n00:03:11,124 --> 00:03:11,517\nSpeaker 1: Yes, exactly.\n\n23\n00:03:11,820 --> 00:03:13,719\nSpeaker 2: So this is like sort of a vaulting mechanism.\n\n24\n00:03:13,801 --> 00:03:14,109\nSpeaker 1: Right, yeah.\n\n25\n00:03:15,506 --> 00:03:16,999\nSpeaker 2: It's actually a dead man's switch kind of thing.\n\n26\n00:03:17,280 --> 00:03:17,844\nSpeaker 0: Yeah, exactly.\n\n27\n00:03:18,066 --> 00:03:19,800\nSpeaker 1: Built in bequesting of your Bitcoins.\n\n28\n00:03:21,300 --> 00:03:23,880\nSpeaker 0: The other thing is, well, Bitcoin Core has always had a wallet.\n\n29\n00:03:25,681 --> 00:03:29,359\nSpeaker 1: There are some people that will not trust other Bitcoins for their Bitcoin Core.\n\n30\n00:03:31,520 --> 00:04:13,479\nSpeaker 0: And okay, going back to the value proposition thing, like there's something to be said for having a wallet that is attached to a full node. And because having your own full node means that you have, gives you better security, better privacy generally. And so having a wallet that's attached to the full node is what a lot of people want, I think. And part of that, even if you had separate software for this, you've raised the barrier of entry. So if someone wants to have a full node wallet, they might have to, oh, you have to download Bitcoin Core. Then they've got to go find some other wallet, figure out how to connect it to Bitcoin Core, and then they can have their full node wallet. Whereas if you just use Bitcoin Core, then everything's all there for you.\n\n31\n00:04:13,840 --> 00:04:26,919\nSpeaker 1: I mean, there is some wallets that actually do use Bitcoin Core, but I think some of them are on Mac. There's some hardware wallets, but you have to get multiple projects to work together in some fashion.\n\n32\n00:04:27,140 --> 00:05:01,839\nSpeaker 2: Yeah, I guess we're not really, I guess I'm just confused about who we're catering to. And if I can be so bold as to tell the person who's been working on Bitcoin Core wallet for five years and has made immeasurable contributions to the wallet, the value prop for me is that it's going to be, there's a higher bar for review and security than anywhere else. And that it's more balanced in terms of showing things like privacy and sort of the innovation pieces, like first half SegWit, first half Taproot, etc. But the security and soundness principles, you're not going to find anywhere else.\n\n33\n00:05:02,340 --> 00:05:05,344\nSpeaker 0: I'm going to contest you on the Asmara view. Oh, great. Wonderful.\n\n34\n00:05:07,680 --> 00:05:27,274\nSpeaker 1: I think we should have that. Actually, we've had a few people come in last year and do more on the wallet. But for a while, the wallet was definitely a part of the code base that got very little action. But the wallet is hopping right now.\n\n35\n00:05:27,636 --> 00:05:58,380\nSpeaker 0: It's hopping. A little bit. I mean, it's been getting more review, more work on it. But the area that we have, there's always some focus that most contributors are looking at at one time. It's not intentional, but I've noticed this over the years that there'll be a focus on P2P, a focus on validation, a focus on networking, a focus on the wallet. And it moves around. So a couple of years ago, we had a pretty big focus on the wallet. And we've kind of moved off that just naturally.\n\n36\n00:05:59,084 --> 00:06:00,359\nSpeaker 2: What was the big focus a couple of years ago?\n\n37\n00:06:00,900 --> 00:06:06,162\nSpeaker 0: Mostly on the refactor and all the whole thing with descriptor wallets. All right.\n\n38\n00:06:06,222 --> 00:06:13,339\nSpeaker 2: Well, we're going to put a pin in that and come back to it because it's important. But what do you think is the hottest area right now?\n\n39\n00:06:13,720 --> 00:06:18,297\nSpeaker 0: I think right now it's with P2P and transaction relay.\n\n40\n00:06:19,641 --> 00:06:21,413\nSpeaker 2: Mempool. Mempool. It's so hot right now.\n\n41\n00:06:24,348 --> 00:06:24,798\nSpeaker 1: Mempool.\n\n42\n00:06:26,389 --> 00:06:27,720\nSpeaker 0: All right. It starts with memes.\n\n43\n00:06:28,120 --> 00:06:38,859\nSpeaker 2: Let's go back a couple of years now and talk about the refactor and the descriptor wallet. Go back to the glory days and tell us about what those projects were about.\n\n44\n00:06:39,300 --> 00:08:18,479\nSpeaker 0: So a long time ago at this point, Peter Walla came up with the idea of these output script descriptors. And the point was to have one string that could be used to represent several scripts, all of the scripts in a wallet actually. And here we're using a script to also mean address, they are interchangeable. So you could have a string that contained all the keys, it contained how to derive those keys, it contained other markers to say like what kind of script to produce and what kind of script probably to produce, which tells us what address we will make. And the goal was to have this in the wallet. A wallet would use these descriptors to produce the addresses. So this would make it really easy to determine what belongs to the wallet. It also makes it a lot easier to upgrade wallets because then you can just say here's a new descriptor and you put it in the wallet and the new descriptor has its definitions will automatically generate all the things. So after Peter had come up with this idea, there was a fork into mini script kind of. And then we started trying to implement it into Bitcoin Core. So this was a fairly big effort. And it turns out that the way that Bitcoin Core was structured was not very good for doing these descriptors. And so before we could even get to that point, we refactored half of it. And there was a lot of work from myself, from Russ, from Mesh Collider, and then a ton of people were reviewing all of these things, testing it out and experimenting with it. So eventually we got the refactor through and we got the script wallets afterwards, which was also quite a bit of work.\n\n45\n00:08:20,220 --> 00:08:40,899\nSpeaker 2: And I guess looking back on that, first of all, those are two big efforts from someone who, you know, you had had contributions before but hadn't led anything like that. Can you tell us what that process was like? It was like leading those giant efforts. I remember when that sort of like gist of this is what the refactor is going to look like came out. I was like, well, that looks like a lot of work. And I was right.\n\n46\n00:08:42,181 --> 00:09:12,919\nSpeaker 0: Yeah. That also was like, I think that was also the third attempt to get the script wallets through. So we have these core dev in-person events and a lot of the discussion around how we were going to do it ended up taking place during a couple of those. Like multiple of them. So this was spread out over quite a while. I guess like it wasn't even that I wanted to lead the project or like lead this effort. I found it interesting and then I just wrote it and being the one to write something ends up putting you in charge of it.\n\n47\n00:09:14,380 --> 00:09:15,464\nSpeaker 2: So it sure does.\n\n48\n00:09:17,092 --> 00:09:31,919\nSpeaker 0: So I wrote the PR. I wrote a couple of different branches and eventually one of them became a PR and people started reviewing it and giving comments. And then like that's basically how I ended up in charge of this whole effort is because I went through the effort of writing it.\n\n49\n00:09:32,220 --> 00:09:36,073\nSpeaker 1: I think was that before or after you were nominated for wallet maintainer.\n\n50\n00:09:36,655 --> 00:09:37,418\nSpeaker 0: I was long before that.\n\n51\n00:09:38,480 --> 00:09:39,623\nSpeaker 2: This is like leaderships.\n\n52\n00:09:40,124 --> 00:09:43,614\nSpeaker 0: This was like 2018, 2019, something like that.\n\n53\n00:09:43,734 --> 00:09:44,576\nSpeaker 1: Oh, two years ago.\n\n54\n00:09:44,897 --> 00:09:45,599\nSpeaker 0: Yeah, two years ago.\n\n55\n00:09:47,905 --> 00:10:09,839\nSpeaker 2: For those who can't see us at home, it's those are air quotes. OK, so you did the refactor. You got the scripture wallets in. Are you happy with where things are at? I mean, I disagree in terms of you're not getting attention. There's the guy sitting at the table with us. There's Fursy. There's Josie. What else do you want, man?\n\n56\n00:10:10,400 --> 00:10:19,559\nSpeaker 0: Well, OK. When I started doing that refactor, I eventually realized actually the way the wallet as it is currently written is kind of really not that great.\n\n57\n00:10:20,460 --> 00:10:23,079\nSpeaker 2: OK, so the refactor ended up not being that great.\n\n58\n00:10:23,440 --> 00:10:39,559\nSpeaker 0: No, like the just in doing the refactor, I learned a lot about how I see the wallet itself actually works. Got it. Yeah. And and in doing that, I it occurred to me that actually this code is not that good. OK. And well, part of it is that you can trace a significant portion of it back to Satoshi.\n\n59\n00:10:40,280 --> 00:10:41,525\nSpeaker 2: God doesn't even know how to write code.\n\n60\n00:10:42,951 --> 00:11:35,180\nSpeaker 0: This is not the not the highest quality of code. And, you know, it makes it hard to implement new changes. And it's also not very performant. So around that time, I also had the idea of, well, why don't we just rewrite this thing? This is not a new idea. Actually, if you look at our IRC meetings, this meme has come up multiple times over many years of why don't we just rewrite the wallet? Actually, at some point, I think it became why don't we just delete the wallet? Because it was getting that hard to work with. And the change to the scripter wallets ended up rewriting, I would say, probably like a third of the wallet. And so there's still two thirds I'm looking at wanting to do. But there just doesn't seem like the appetite. Yeah. The appetite for reviewers to look at these changes and to go through with a lot of the things involved in doing this kind of rewrite.\n\n61\n00:11:35,360 --> 00:11:37,918\nSpeaker 2: And what do you think that other two third rewrite will get us?\n\n62\n00:11:38,680 --> 00:12:18,700\nSpeaker 1: So I looked the first time really at the wallet in 2014 when I got interested in coin selection. And you could probably pretty easily still figure out that all of Bitcoin was a part of a single file at some point. Almost. It all came out of main.cpp and people had pulled out a few things. For example, the coin selection stuff had not really been touched since 2011. Somebody introduced an app sack then. before that, I think it was just either largest first selection or oldest first selection. No, it used all UTXOs for every transaction. Yes, at some point it used all UTXOs for every transaction.\n\n63\n00:12:18,900 --> 00:12:19,400\nSpeaker 0: I don't remember this.\n\n64\n00:12:20,761 --> 00:12:22,459\nSpeaker 2: Guy has a master's thesis. I wouldn't mess with him.\n\n65\n00:12:24,061 --> 00:12:42,017\nSpeaker 0: The very first version of Bitcoin chose coins by TXID order. It used a standard map, which is a sorted data structure, and it was sorted by TXID. So it would take the first thing out of standard map. It wasn't enough to take the second one, the third one, and so on.\n\n66\n00:12:43,526 --> 00:12:44,200\nSpeaker 2: Seems very efficient.\n\n67\n00:12:44,680 --> 00:12:47,523\nSpeaker 0: Oh, it was very fast. I'm sure it's very fast. Quite performant.\n\n68\n00:12:48,026 --> 00:12:50,339\nSpeaker 2: You're recusing Satoshi not being performant.\n\n69\n00:12:51,281 --> 00:12:54,519\nSpeaker 0: But it's not very good for fee optimization. Like anything else.\n\n70\n00:12:55,060 --> 00:13:12,798\nSpeaker 1: Yeah, anyway, somebody put in knapsack. Knapsack is terrible. We still have knapsack. And then I think Alex Morkos fixed something about the looping behavior after my master thesis, and then nobody touched that part of the wallet until 2018.\n\n71\n00:13:14,082 --> 00:13:38,460\nSpeaker 0: Until 2017, something like that. So the way that we did coin selection changes was people would use it. They would find, oh, there's this really weird behavior if you do this one really specific thing. And you'd be like, okay, we will fix that thing. Here's an if statement for some wild condition that you probably shouldn't hit, but it's there, and it resolves this problem. And that's how we did coin selection. It was completely ad hoc.\n\n72\n00:13:38,480 --> 00:13:41,099\nSpeaker 2: It sounds like an elegant solution. What could go wrong?\n\n73\n00:13:41,720 --> 00:14:11,800\nSpeaker 0: Yeah, it was just completely ad hoc. And there was no overall, like, what do we want coin selection to do? What are we trying to target with it? What kind of coins do we want? What fee rates? All that stuff. None of that was really in consideration, I think. And it was mostly just like, here's a thing that we inherited from people who wrote something several years ago, and now it doesn't work. It's completely black magic. We don't know why it doesn't work. We don't know what the hell it's actually doing. And we're just going to throw some special case in for this one broken behavior.\n\n74\n00:14:12,520 --> 00:14:24,140\nSpeaker 2: Yeah, so one of the things that I think seems to have helped with some of that is you have recently done some simulation work so that you can actually simulate some of this behavior. So tell me more about that project.\n\n75\n00:14:25,363 --> 00:14:47,299\nSpeaker 0: So this started when I was interning at Blockstream in 2017. And one of my projects then was to implement Merger's coin selection algorithm in Bitcoin Core. And of course, because coin selection was at that time just a black box, no one knew how it actually worked, there was a question of, well, can you demonstrate that this is better for some definition of better that is still undefined?\n\n76\n00:14:49,082 --> 00:14:53,278\nSpeaker 2: So I wrote a whole thesis about that. What's the framework of better then?\n\n77\n00:14:54,760 --> 00:15:19,959\nSpeaker 1: Well, there's different metrics that you could use. Mine was, what is the overall fee cost and how healthy is the wallet in the end? As in, if you keep fragmenting your wallet more and more, your long-term fees that you have essentially, for every UTXO that you have in your wallet, you will have to spend money in the future to spend it. So the more fragmented your wallet is, the more future costs you have already locked in.\n\n78\n00:15:20,340 --> 00:15:27,799\nSpeaker 2: But there are other metrics associated with that. So for example, just like a human, be like, well, my cholesterol is high, but my pulse is good. Am I healthy?\n\n79\n00:15:28,182 --> 00:15:28,517\nSpeaker 0: Who knows?\n\n80\n00:15:30,260 --> 00:15:43,020\nSpeaker 1: So I mean, not that strictly where you can look at a single number and you can say, oh, my health score is like that. But we found ways to compare different approaches and see which one is better.\n\n81\n00:15:43,020 --> 00:15:46,259\nSpeaker 2: Are those being integrated into our criteria?\n\n82\n00:15:47,841 --> 00:15:50,190\nSpeaker 0: The waste metric is one of these.\n\n83\n00:15:53,160 --> 00:16:16,939\nSpeaker 1: With Jose, I've been talking on and off about how the waste metric should only be one of multiple things that contribute to the score. And we would like to have some scoring mechanism for privacy as a second contributor to which inputs we select. So I don't think it's been our focus yet, but we've been bouncing around some ideas.\n\n84\n00:16:17,600 --> 00:16:30,198\nSpeaker 0: With coin selection, I think, well, so I ended up using a lot of Merckx's stuff because he was the only one who actually seemed to know anything about coin selection. There was a master's thesis.\n\n85\n00:16:31,720 --> 00:16:32,718\nSpeaker 2: That's why we hired him.\n\n86\n00:16:34,100 --> 00:16:36,019\nSpeaker 1: I thought it was for my Stack Exchange answers.\n\n87\n00:16:37,838 --> 00:17:09,279\nSpeaker 0: Yes. So in 2017, I implemented the Merckx's algorithm, which we call branch and bound. And then in doing that, learned about how coin selection works and doesn't work and realized how our coin selection algorithm was not that good. And this also led to another refactor that ended up being delayed quite a long time just to like clean up coin selection and just to like, you know, get rid of some other dumb behavior that we had in it.\n\n88\n00:17:10,320 --> 00:17:35,059\nSpeaker 2: So you've taken on us on this tour of getting to coin selection and talking about, you know, simulated behavior, which gives us actually some criteria to compare against, which seems like a good idea. But these aren't your only projects. You've also been thinking about like you led the effort on PSBTs. There's hardware integration. How do these all fit together?\n\n89\n00:17:35,661 --> 00:17:46,319\nSpeaker 0: At some point I got a hardware wallet and I was like, why can't I use this with Bitcoin Core? Turns out because it's very hard.\n\n90\n00:17:48,420 --> 00:18:20,139\nSpeaker 1: So basically you were saying, hey, I want to be able to transfer a unsigned transaction between one device and another device. And I need a standardized format for that. And it turns out that introducing a format for talking about unsigned or half signed or partially signed transactions is something that a lot of people actually also need and have implemented before. But having a single standard for it was pretty awesome. And down the road, what it makes much, much easier is multi-party transactions.\n\n91\n00:18:21,160 --> 00:20:10,880\nSpeaker 0: So I wrote HWI as mostly just a toy for experimentation. So Trezor provided a Python library. So I wrote it in Python. Which I really enjoyed. Ledger also provided a Python library. What was the other one I had at the time? No, that didn't exist yet. DigitalBitBox. They had a really simple protocol that I could implement in Python. And there might have also been a Python library. So I did it all in Python, mostly for myself. And I found out that, okay, I can get a thing that Bitcoin Core can watch. But how do I get transactions out of Bitcoin Core into this script and get that to all the devices, including all the other information that they need to sign? And that stuff includes, for each of those devices, they have different protocols. So you now need to take it in some common format that can give to my program. That needs to convert it into all these other protocols that I can send out to the device. And then recombine it. And it all has to come back out and go the other way into Bitcoin Core. So it turns out that in doing that, I decided to write PSBT as that common data format to transfer information from Bitcoin Core to HWI. And so these two projects were, PSBT and HWI were intrinsically linked from the start. And of course, it turns out that a way to transfer data about transactions to be signed between two different pieces of software is actually really useful, even if one end is not a hardware wallet. Because all of that hardware wallet signing stuff is abstracted away. So being able to have something that I can pass around between different compatible software was really useful for the ecosystem.\n\n92\n00:20:11,640 --> 00:20:17,399\nSpeaker 2: And then besides the implicit, it's useful. What other things are using this kind of thing?\n\n93\n00:20:17,840 --> 00:20:48,179\nSpeaker 0: The other thing is multi-party transactions. Because we can, just the way that I had written it, and this was also kind of on my mind when I was doing it, but it allows us to do things like multi-sigs or coin-joints. Anything that required having multiple people involved was made easier by having PSBT because now it was a common data format that contained all the information you needed to know in order to sign it, except for the private keys, obviously. And so you can just pass around to everyone, they can sign it, and it just makes life a lot easier.\n\n94\n00:20:48,621 --> 00:21:08,359\nSpeaker 1: And then now on the other side of this equation, of course, wallets started saying, hey, wait, there's a shared format for talking about partially signed Bitcoin transactions. And now the hardware wallets and other wallets are implementing that, and we get a global standard in how wallets can communicate with each other.\n\n95\n00:21:09,160 --> 00:21:26,719\nSpeaker 0: And one thing I found was that the idea of having a format containing information you need in order to sign is not new. There was a BIP 10, something like that, it was very old, that did something similar to PSBT, but not quite, and it ended up being withdrawn for some reason.\n\n96\n00:21:27,500 --> 00:21:28,080\nSpeaker 2: Who wrote it? Do you know?\n\n97\n00:21:29,304 --> 00:21:50,079\nSpeaker 0: The armory guy, Alan Reiner. Someone pointed this out to me, I was like, oh, I just didn't realize this existed. I read it, it's not the same, and it was missing a bunch of things, I think. But this is not new. Electrum had their own custom format. Bitcoin Core did a thing where it would shove signatures into the raw transaction.\n\n98\n00:21:50,720 --> 00:21:52,598\nSpeaker 1: I mean, BitGo had its own format, too.\n\n99\n00:21:52,760 --> 00:22:05,219\nSpeaker 0: Yeah, I know BitGo had their own format, Zappo had their own format, just for internal use. And no one ever thought to standardize it until I came along and wrote my own thing, and was like, maybe this would be useful for everyone else.\n\n100\n00:22:06,802 --> 00:22:15,740\nSpeaker 2: It's clear that you've developed this affinity for the wallet. Mm-hmm. Merch already mentioned it, like you became maintainer within the last, it's been about a year, right? December?\n\n101\n00:22:16,260 --> 00:22:16,937\nSpeaker 0: Yeah, I think so.\n\n102\n00:22:17,440 --> 00:22:34,519\nSpeaker 2: So has that changed things for you? Has it changed things, how you approach the wallet, how you think about its future? I mean, we sort of have this idea around maintainership, it's not like an explicit lead, but it often goes to the person who's most active in that area. So how does that change things for you?\n\n103\n00:22:35,961 --> 00:23:19,839\nSpeaker 0: It doesn't change a whole lot in terms of the things that I want to do. It changes how much time I have to do them. So since I've became a maintainer, I've been doing a lot more review, and not just the wallet stuff, because we know, I mean, recently, relatively recently, both Peter and Vytomir have stepped down as maintainers. And we do need maintainers to look at all parts of the code base. You know, things still need to be merged. And I've started doing a bit more of that, just looking around at the other parts of the code base, reviewing things that aren't in the wallet, reviewing things that I don't write code for. And so that has, of course, eaten into the amount of time I can spend on the wallet.\n\n104\n00:23:20,941 --> 00:23:25,175\nSpeaker 2: Is spend a pun there? Is that a pun? No. We'll cut that bit.\n\n105\n00:23:28,780 --> 00:23:43,954\nSpeaker 0: So yeah, it's eaten into the amount of time I work, I spend on the wallet. But I still have a plan. I still have things I want to work on. It just takes a little bit longer. I mean, I already knew it would take a long time. So what do you want to work on?\n\n106\n00:23:43,974 --> 00:23:44,279\nSpeaker 2: What's next?\n\n107\n00:23:44,880 --> 00:23:53,059\nSpeaker 0: So what's next? I have like five branches named wallet UTXO set. They're all failed attempts at doing this next thing.\n\n108\n00:23:53,661 --> 00:23:55,439\nSpeaker 2: What is that? What's the next thing?\n\n109\n00:23:55,762 --> 00:23:57,499\nSpeaker 1: What is the motivation for that one?\n\n110\n00:23:58,360 --> 00:24:36,679\nSpeaker 0: So the name might not mean a whole lot, but what I want to achieve is to have the wallet actually track its own UTXOs. And everybody will be wondering, well, it doesn't already do that. It doesn't. So when you ask the wallet, what's my balance? We have some caching, but it will say, let me check every single transaction I've stored. See, look at every single output. Determine, does this output belong to the wallet? And I will add it to a running total. And it does that with some caching to figure out what's your balance. Does the same thing for what UTXOs are mine and I can spend. It doesn't explicitly maintain a data structure for our UTXOs.\n\n111\n00:24:37,060 --> 00:24:43,559\nSpeaker 1: But every single time you build a transaction, it will recalculate its UTXO pool for all the history of the wallet.\n\n112\n00:24:44,380 --> 00:24:49,819\nSpeaker 0: So for really big wallets, this is kind of problematic. Fortunately, C++ is extremely fast.\n\n113\n00:24:52,580 --> 00:24:57,919\nSpeaker 2: Orinorck, in this case, unfortunately, because you have to do this ridiculous operation.\n\n114\n00:24:57,980 --> 00:25:02,279\nSpeaker 1: People that try to run a business using Bitcoin Core wallets have noticed this problem.\n\n115\n00:25:03,641 --> 00:25:06,879\nSpeaker 0: It used to be worse before there was caching. So we do caching now.\n\n116\n00:25:07,060 --> 00:25:08,779\nSpeaker 2: I don't assume that other wallets run this way.\n\n117\n00:25:09,260 --> 00:25:15,201\nSpeaker 0: Well, I will not say this is like an unreasonable approach for a first implementation. Sure.\n\n118\n00:25:15,502 --> 00:25:19,394\nSpeaker 2: But this is where, you know, Satoshi has been gone for a little bit.\n\n119\n00:25:19,876 --> 00:25:54,159\nSpeaker 0: Interesting. So the next thing I want to do in this rewrite of the wallet is to change how we do UTXO tracking. To actually store UTXOs and to do things where like we're also like we load in a bunch of transactions that are completely irrelevant because every single output has been spent. Or we load in transactions because they exist on disk and maybe they are completely irrelevant. So something that I've been thinking about and working on and off and have had multiple failed attempts at is to change how we do transaction and UTXO management.\n\n120\n00:25:54,860 --> 00:25:55,739\nSpeaker 2: Sounds like a pretty big swing.\n\n121\n00:25:57,920 --> 00:26:05,259\nSpeaker 1: So you mentioned to me earlier that in your mind, the wallet really consists of three different components. Do you want to elaborate?\n\n122\n00:26:05,701 --> 00:26:32,499\nSpeaker 0: So I think there is the key and script management component. And this is the descriptor wallet kind of stuff. Doing the refactor for descriptor wallets like produced a separate component for key and script management. The next part I would say is transaction creation. So this covers like coin selection, just generally how we create transactions, some privacy things like. do we do anti-fee sniping and you know, what are the users desires for their transaction?\n\n123\n00:26:33,243 --> 00:26:33,600\nSpeaker 1: Output grouping.\n\n124\n00:26:34,140 --> 00:26:40,299\nSpeaker 0: Output grouping, all that kind of stuff. And then the last part is transaction storage and management, UTXO management.\n\n125\n00:26:41,040 --> 00:26:41,660\nSpeaker 1: Wallet history.\n\n126\n00:26:42,860 --> 00:26:53,099\nSpeaker 0: I guess there actually there's a fourth part which is metadata. Like address book data, data about like comments on transaction, that kind of stuff. But that's not, that doesn't seem to be problematic yet.\n\n127\n00:26:53,740 --> 00:27:08,399\nSpeaker 2: I want to return to an earlier theme a little bit. You had said that the wallet in Bitcoin Core was important because you didn't want any barriers for new users running in node. Do we know much about our users? Obviously there's not tracking, but you were involved in that MIT study.\n\n128\n00:27:09,160 --> 00:27:22,159\nSpeaker 0: Yeah, there was this spawn from an offhand comment I made to Mesh Collider a couple years ago. I was like, why don't we just like run a survey of our users, like post a survey, see what people respond to it. It didn't go as I expected it to go.\n\n129\n00:27:23,121 --> 00:27:26,939\nSpeaker 2: Which is you wanted it to go. It went better than you thought. Not quite.\n\n130\n00:27:28,501 --> 00:27:29,076\nSpeaker 1: How did it go?\n\n131\n00:27:30,321 --> 00:28:38,260\nSpeaker 0: I don't think we could get very much use of actionable data out of it. I have posted all, I think I've posted all of the raw data online. So if someone wants to do some analysis on it, they can do that. But I think what ended up happening was that the questions that we asked were probably not that good. And so what we got out of it, garbage in, garbage out. When I was looking at it last time I looked at it, I didn't think that there was much actionable results from it. We did learn a couple things. There are a lot of people who use Bitcoin Core because it is attached to a full node. There are people who use it because they have- People who want just Bitcoin Core because it's full node. and people who are like, I wanted something that was full node and the software I'm using said use Bitcoin Core. But we didn't really get any data on how people were using the wallet. Although one other thing I did learn is that no one changes their defaults.\n\n132\n00:28:38,960 --> 00:28:54,859\nSpeaker 1: I think that's pretty- If somebody reports an issue, we might be like, oh, this is interesting. Maybe we should do something about this.\n\n133\n00:28:55,561 --> 00:29:21,120\nSpeaker 0: Yeah. So a lot of changes have been prompted by people doing something and reporting an issue. The reason I actually started looking at transaction management, not because it was inefficient. when I read the code. I noticed that and I was like, cool. But no one's really complaining about this yet. And then someone complained about it. And someone with an enormous wallet.\n\n134\n00:29:21,500 --> 00:29:25,640\nSpeaker 2: But there's people complaining about the GUI and the GUI gets no love.\n\n135\n00:29:26,644 --> 00:29:28,759\nSpeaker 0: That's not true. The GUI does.\n\n136\n00:29:29,100 --> 00:29:30,098\nSpeaker 2: Tell me more about the GUI.\n\n137\n00:29:30,860 --> 00:29:43,680\nSpeaker 0: It gets love in a different repo. So we have a separate repo for overhauling the GUI entirely using QML. And that's actually been getting a lot of activity in designing a new interface, designing something that doesn't suck. Right.\n\n138\n00:29:44,021 --> 00:29:50,299\nSpeaker 2: So apparently hot news on this podcast. It will be released within the next two weeks. TM.\n\n139\n00:29:50,731 --> 00:29:50,917\nSpeaker 0: Yeah.\n\n140\n00:29:52,203 --> 00:29:54,159\nSpeaker 2: But Harold and team are hard at work.\n\n141\n00:29:54,961 --> 00:30:01,998\nSpeaker 0: Yes. Essentially the GUI redesign is something that has been getting a lot of eyes. The current GUI doesn't. But that's mostly because it's bad, I think.\n\n142\n00:30:04,142 --> 00:30:15,199\nSpeaker 2: But this is the whole point is like, if something's bad and people complain, I've heard like, well, you're just not the right user. You know, drop down to the command line. It'll work great. But then you tell us that it actually doesn't.\n\n143\n00:30:15,760 --> 00:30:36,340\nSpeaker 0: Well, yeah, I don't like responses like that because I don't know if I collected this in the survey, but I think most people who use Bitcoin Core actually like you use it actually as a wallet, use it through the GUI, including myself. Yeah. When I want to use as a wallet, I use it through the GUI because I'm lazy. So having a good user experience in the GUI is important.\n\n144\n00:30:36,800 --> 00:31:01,379\nSpeaker 2: But do you think that'll drastically affect the like the raw number of users that will use it? Or like what is that going to change? Because if people are using Bitcoin Core wallet because it's attached to a full node, making it an amazing user experience, is it really going to outcompete these newfangled, you know, wallets that have a big design team and et cetera, et cetera?\n\n145\n00:31:02,141 --> 00:31:07,239\nSpeaker 0: I think it can. Or perhaps the bar is just really low right now.\n\n146\n00:31:08,920 --> 00:31:09,937\nSpeaker 2: That's what we're all striving for.\n\n147\n00:31:10,940 --> 00:31:14,883\nSpeaker 1: I mean, especially for desktop wallets. It's just not that much. So\n\n148\n00:31:15,586 --> 00:31:59,719\nSpeaker 0: if you go on like Bitcoin Talk, which I do far more frequently than I should, and you look at like what new users are opening new threads about, if they're talking about Bitcoin Core, there's a lot of time it'll be like, how do I do this in Bitcoin Core? And the response is, we got to open the debug console. You got to type these commands in. And it's like, that's not a good user experience. And you're like, OK, how can I? And then they have trouble doing it. And so then the response is, just switch to Electrum or just switch to this other wallet because it's a better user experience. And I think if we can improve the GUI, as I said, the bar is pretty low. So if we can improve the GUI so that people don't feel like they need to switch to a different software in order to use it.\n\n149\n00:31:59,800 --> 00:32:17,059\nSpeaker 2: It just feels like all the elements are there for the big use case, which I think continues to be lacking in the ecosystem. I know there's Sparrow and I know there's Spectre and there's some other solutions out there. Electrum, of course. But a really nice multisig with hardware wallet integration, I think that would be a game changer.\n\n150\n00:32:17,640 --> 00:32:25,559\nSpeaker 0: Yeah, probably. And I think there are some people who have been working on stuff like that. But not necessarily in a nice GUI form.\n\n151\n00:32:26,860 --> 00:32:28,280\nSpeaker 2: Cool. Anything else we want to talk about?\n\n152\n00:32:28,780 --> 00:32:51,838\nSpeaker 1: Maybe the move from legacy wallet to descriptor wallet. There's users that have had their Bitcoin Core wallet for a decade. And I know that a recent version had a converter that allows you to convert a legacy wallet to a descriptor wallet. New wallets obviously created by recent versions will be descriptor wallets already. Can you tell us a little bit about that?\n\n153\n00:32:52,981 --> 00:33:10,559\nSpeaker 0: Yeah. So descriptor wallets, after we did the whole refactor, it turned out, well, because descriptor wallets were so fundamentally different that we had to do the refactor. They're just completely incompatible with the old style wallet, which we call legacy wallets. Legacy is not a great term to be using here. It's used in too many places.\n\n154\n00:33:11,060 --> 00:33:11,540\nSpeaker 2: Deprecated wallets?\n\n155\n00:33:11,960 --> 00:34:30,839\nSpeaker 0: I guess. I don't know. But the main thing was we needed to, we didn't want to break forwards compatibility. So if you, in theory, if you take a wallet from 0.2-ish, you can open it in current 24.0. And it will load and it will be missing all of the modern features, but it will still work. And you can use that wallet. With descriptor wallets, it's completely different. So if we had a software that was descriptor wallet only and you tried to do that, it would just tell you this wallet, we don't know what this wallet is. And you wouldn't be able to do that. So we wanted to at least make it possible. People would freak out. So we wanted to have a way to, one, to just convert those kinds of wallets to descriptor wallets after we get rid of the legacy wallet. And then we also want to have a smoothed out deployment timeline. So we start with, OK, we introduced descriptor wallets as a new thing, but it's not the default. Then we change it to the default. Then we say, if you start loading a legacy wallet, we're going to tell you, hey, this thing is deprecated and it's going to go away eventually. And then we say, we upgrade that later to, hey, this thing is deprecated and it's going to go away soon. And then it's, hey, this thing is deprecated. You need to turn on this option to use it. And then it's, hey, this thing doesn't exist anymore.\n\n156\n00:34:31,880 --> 00:34:44,916\nSpeaker 2: And so for that last part, I mean, there's a fundamental Bitcoin philosophy that you should be able to wake up sometime in the future and your money will still be your money. Yeah. But that seems to be broken here.\n\n157\n00:34:45,900 --> 00:35:44,758\nSpeaker 0: Not quite. So somewhere in the middle of that is a migration tool, which we've added in 24.0. And so the migration tool takes the legacy wallet and converts it entirely into a descriptor wallet so you can continue to use it. When I was writing this tool, one of the things I wanted to do was make sure that this thing can work even after the legacy wallet has been removed. So there's an open PR to replace the database back end that it uses from BDB to a key-to-the-line. And then it will take a self-written implementation of just a BDB parser. So after we've removed the legacy wallet and you get the error saying, hey, we can't load this anymore, it will also say, but you can migrate it. If you click this button or type this command, we will convert your wallet into a descriptor wallet and you will not be missing anything. You won't be missing anything if you do that. So that's like the goal for this whole rollout of descriptor wallets or like the plan that is hopefully going to happen soon because we're going to have to do that. Developers have been getting increasingly annoyed with BDB.\n\n158\n00:35:45,440 --> 00:35:48,100\nSpeaker 2: And that conversion tool will stay in the codebase forever?\n\n159\n00:35:48,260 --> 00:36:00,239\nSpeaker 0: Yeah, so this conversion tool will live in the codebase forever, but it's like a very small subset of all the legacy wallet things that it won't be hard to maintain. And it can just kind of live in its own couple of files.\n\n160\n00:36:01,240 --> 00:36:24,939\nSpeaker 1: So one of the issues with the legacy wallets, for example, is that we simply had a chain of keys. And we don't know what output they were used for. So each key could be any type of output. And in descriptor wallets, of course, a big advantage is that we store explicitly what output we are generating. So are descriptor wallets more performant then?\n\n161\n00:36:25,623 --> 00:38:44,079\nSpeaker 0: Sometimes. We don't really have benchmarks for this, so it's hard to say. So one of the things with legacy wallets is that there's no explicitly defined set of scripts that we are watching for. And actually, this set was unbounded for a very long time. So there's the obvious ones. So the way that it would work is we would see some script and we'd say, figure out what kind of script is this? Is it P2-PKH? Is it P2-WPKH? Is it P2-SH? Or is it a bare multi-sig? And then we would say, do we have any keys that would match this? So if we got a P2-PKH script, we'd be like, do we have any keys whose hash matches this one? And we'd be like, if we do, okay, this is ours. And so actually that's pretty easy to determine the set of scripts for. You just hash all your keys, right? Same thing for P2-WPKH and nested P2-WPKH. But when you get to bare multi-sig, so bare multi-sig is a script that's just the multi-sig script, but in an output and not behind a P2-SH. And the way we would look at those is, does any of our keys appear in this bare multi-sig? And then do we have enough keys in the bare multi-sig to sign it? So you could have, I think the standardness is up to three keys, but I believe this would work on any bare multi-sig that shows up in the blockchain, which is up to 15 keys. And we only need whatever the N number is. So this is literally infinite. You could have one of 15, one of my thousand keys is in here, and then I have 15 unrelated keys. And our wallet would be like, yep, that's ours. So that turns the set from, okay, we can calculate to just hash all the keys to. it's literally any bare multi-sig. And this posed a huge problem. And then someone had the foresight of saying that if we wanted bare multi-sigs, then you had to explicitly import them to your wallet. But this was a breaking change, right? So if you were, for some reason, expecting a bare multi-sig to be seen by your wallet as belonging to it, and then you upgraded that new version that had this change of required explicit bare multi-sig import, suddenly those would no longer be yours. But also no one does bare multi-sigs, so it doesn't matter.\n\n162\n00:38:45,740 --> 00:38:48,138\nSpeaker 1: Yeah, because they write the data now to input since then.\n\n163\n00:38:50,362 --> 00:38:57,057\nSpeaker 2: Does any of this matter? I guess we'll, you know. Awesome. Thank you for the discussion. We covered a lot of ground here. Good talking with you.\n\n164\n00:39:07,350 --> 00:39:08,012\nSpeaker 0: All things wallet.\n\n165\n00:39:08,032 --> 00:39:09,936\nSpeaker 2: I don't know if we can talk about wallets anymore.\n\n166\n00:39:09,956 --> 00:39:11,759\nSpeaker 0: A lot of wallet stuff.\n\n167\n00:39:12,300 --> 00:39:21,299\nSpeaker 1: It feels like, I hope nobody is shocked when they listen to us talking about the Bitcoin Core wallet. There seem to be a lot of construction sites.\n\n168\n00:39:21,500 --> 00:39:33,780\nSpeaker 2: I think when you're so close to something, you see all the flaws. But it's still, I stand by the fact that it has the most review and the highest bar in terms of security.\n\n169\n00:39:34,260 --> 00:40:01,979\nSpeaker 1: I think that it definitely benefits from a lot of the people that actually do use Bitcoin Core wallet, being the Bitcoin Core developers. And frequently when they have some sort of feature they want, they come in and look at it and implement something for it to scratch their own itch. And yeah, so that's I think where we get some of the more unique features and definitely also some of the unique review.\n\n170\n00:40:03,080 --> 00:40:10,578\nSpeaker 2: Cool. Well, I hope you enjoyed the episode. And I think we're going to try to get another one in soon. I don't know. If we start doing them once a week, what happens to us?\n\n171\n00:40:10,941 --> 00:40:13,059\nSpeaker 1: I don't know. People will probably get bored.\n\n172\n00:40:15,323 --> 00:40:15,987\nSpeaker 2: Hopefully not us.\n\n173\n00:40:16,570 --> 00:40:17,696\nSpeaker 1: All right.\n\n174\n00:40:17,736 --> 00:40:18,219\nSpeaker 2: We'll see you soon.\n\n"}